<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXPLORE - WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/explore.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body class="explore-page">

    <header class="site-header">
        <div class="logo-container">
            <a href="index.html">
                <img src="images/3D_newLogo.svg" alt="WHAT U VIBIN TO?" class="header-logo">
            </a>
        </div>
        <button class="menu-btn" id="menuBtn" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <div class="menu-panel" id="menuPanel">
        <nav class="menu-nav">
            <a href="explore.html" class="menu-link highlight">
                <span class="en-text">Explore</span>
                <span class="jp-sub">あの人が"この時間"に聞いている曲をのぞく</span>
            </a>
            <a href="how.html" class="menu-link">
                <span class="en-text">How it works</span>
                <span class="jp-sub">このQRの仕組み/使い方</span>
            </a>
            <a href="getQR.html" class="menu-link">
                <span class="en-text">Get Your QR</span>
                <span class="jp-sub">あなただけのQRをつくる</span>
            </a>
        </nav>
    </div>

    <div class="explore-container">
        
        <div class="dig-content">
            
            <div class="explore-hero">
                <img src="images/3D_newLogo.svg" alt="WHAT U VIBIN TO?" class="explore-hero-logo">
                <p class="explore-hero-copy">
                    このQRは、生きている。<br>
                    あの人の"この時間"に聴いている音を見てみよう。
                </p>
            </div>

            <div class="search-area">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Name or Location...">
                    <button class="search-btn">SEARCH</button>
                </div>
                
                <div class="genre-filter-area">
                    <div class="genre-label">FILTER BY GENRE:</div>
                    <div class="genre-checkboxes" id="genreCheckboxes"></div>
                    <button class="filter-reset-btn" id="resetBtn" style="display:none;">RESET (ALL)</button>
                </div>
            </div>

            <div class="profile-list" id="profileContainer"></div>
        </div>

        <footer class="site-footer">
            © 2026 WHAT U VIBIN TO / One QR, different vibes
        </footer>
    </div>

    <div class="qr-modal-overlay" id="qrModal">
        <div class="qr-modal-content art-layout">
            <button class="qr-modal-close" onclick="closeQrModal()"></button>
            
            <div class="art-image-section">
                <img src="" alt="Profile Photo" id="modalPhoto">
            </div>

            <div class="art-info-section">
                
                <div class="art-info-header">
                    <div class="art-name-row">
                        <h2 class="art-name" id="modalName">NAME</h2>
                        <span class="art-role-badge" id="modalRole">DJ</span>
                    </div>

                    <div class="art-meta-row">
                        <span class="art-location" id="modalLocation">TOKYO</span>
                        <span class="art-slash">/</span>
                        <span class="art-genre" id="modalGenre">GENRE</span>
                    </div>
                </div>

                <div class="art-qr-wrapper">
                    <div class="art-qr-box">
                        <a id="modalQrLink" href="#" target="_blank" rel="noopener noreferrer">
                            <img src="" alt="QR Code" id="modalQr">
                        </a>
                    </div>
                    <p class="art-instruction-text">Tap or Scan the QR</p>
                </div>

                <div class="art-info-footer" id="modalInstaArea">
                    <a id="modalInstaLink" href="#" target="_blank" rel="noopener noreferrer" class="art-insta-link">
                        <div class="insta-left">
                            <img src="images/InstagramLogo.png" alt="IG" class="insta-icon">
                            <span class="insta-val" id="modalInstaName">username</span>
                        </div>
                        <span class="art-instruction-text">Tap & Check the profile</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="js/dig_data.js"></script>

    <script>
        const menuBtn = document.getElementById('menuBtn');
        const menuPanel = document.getElementById('menuPanel');
        let isMenuOpen = false;

        menuBtn.addEventListener('click', () => {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                menuPanel.classList.add('active');
                menuBtn.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                menuPanel.classList.remove('active');
                menuBtn.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    </script>

    <script>
        const container = document.getElementById('profileContainer');
        const modal = document.getElementById('qrModal');
        const modalName = document.getElementById('modalName');
        const modalGenre = document.getElementById('modalGenre');
        const modalPhoto = document.getElementById('modalPhoto');
        const modalQr = document.getElementById('modalQr');
        const modalQrLink = document.getElementById('modalQrLink');
        const modalRole = document.getElementById('modalRole');
        const modalLocation = document.getElementById('modalLocation');
        const modalInstaArea = document.getElementById('modalInstaArea');
        const modalInstaLink = document.getElementById('modalInstaLink');
        const modalInstaName = document.getElementById('modalInstaName');
        const searchInput = document.getElementById('searchInput');
        const genreContainer = document.getElementById('genreCheckboxes');
        const resetBtn = document.getElementById('resetBtn');

        let currentSearchTerm = '';
        let selectedGenres = []; 
        let profileData = [];
        
        if (typeof window.digData !== 'undefined') {
            profileData = window.digData;
        } else if (typeof digData !== 'undefined') {
            profileData = digData;
        }

        function init() {
            if(profileData.length > 0) {
                profileData.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                generateGenreCheckboxes(); 
                renderProfiles(profileData); 
            }
        }

        function generateGenreCheckboxes() {
            let allGenres = [...new Set(profileData.flatMap(person => person.genre))].sort();
            const mixTag = "DJ MIX";
            if (allGenres.includes(mixTag)) {
                allGenres = allGenres.filter(g => g !== mixTag); 
                allGenres.unshift(mixTag); 
            }
            let html = '';
            allGenres.forEach(genre => {
                const specialClass = (genre === mixTag) ? 'special-tag' : '';
                html += `<label class="genre-tag ${specialClass}"><input type="checkbox" value="${genre}" onchange="handleGenreChange(this)"><span class="genre-name">${genre}</span></label>`;
            });
            genreContainer.innerHTML = html;
        }

        function renderProfiles(data) {
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px; font-weight:bold;">NO VIBES FOUND...</p>';
                return;
            }
            let html = '';
            data.forEach((person, index) => {
                const delay = index * 0.05; 
                const genreText = person.genre.join(', ');
                const serviceIconUrl = person.serviceIcon || "images/default_icon.png"; 
                const role = person.role || "";
                const roleBadge = role ? `<span class="role-badge">${role}</span>` : "";
                let linkUrl = person.id ? `profile.html?id=${person.id}` : (person.qrLink || "#");
                const instaId = person.instagram || "";
                const location = person.location || "";

                html += `
                <div class="profile-card" style="animation-delay: ${delay}s" 
                     onclick="openQrModal('${person.name}', '${genreText}', '${person.image}', '${person.qr}', '${linkUrl}', '${instaId}', '${role}', '${location}')">
                    <div class="profile-img"><img src="${person.image}" alt="${person.name}">${roleBadge}</div>
                    <div class="profile-info">
                        <h2 class="profile-name">${person.name}</h2>
                        <span class="profile-loc">${person.location}</span>
                        <div class="profile-bottom-row">
                            <div class="mini-qr-wrapper"><img src="${person.qr}" alt="QR" class="mini-qr"></div>
                            <div class="service-icon-wrapper"><img src="${serviceIconUrl}" alt="Service" class="service-icon"></div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function applyFilters() {
            const filtered = profileData.filter(person => {
                const term = currentSearchTerm.toLowerCase();
                const textMatch = !term || person.name.toLowerCase().includes(term) || person.location.toLowerCase().includes(term) || person.genre.some(g => g.toLowerCase().includes(term));
                const genreMatch = selectedGenres.length === 0 || person.genre.some(g => selectedGenres.includes(g));
                return textMatch && genreMatch;
            });
            renderProfiles(filtered);
            resetBtn.style.display = selectedGenres.length > 0 ? 'inline-block' : 'none';
        }

        searchInput.addEventListener('input', (e) => { currentSearchTerm = e.target.value; applyFilters(); });
        window.handleGenreChange = function(checkbox) {
            const val = checkbox.value;
            if (checkbox.checked) selectedGenres.push(val); else selectedGenres = selectedGenres.filter(g => g !== val);
            applyFilters();
        };
        resetBtn.addEventListener('click', () => {
            selectedGenres = [];
            genreContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            applyFilters();
        });

        window.openQrModal = function(name, genre, imageSrc, qrSrc, linkUrl, instaId, role, location) {
            modalName.textContent = name;
            modalGenre.textContent = genre;
            modalLocation.textContent = location;
            modalPhoto.src = imageSrc;
            modalQr.src = qrSrc;
            modalQrLink.href = linkUrl;
            
            // Roleの表示制御
            if (role) { 
                modalRole.textContent = role; 
                modalRole.style.display = "inline-block"; 
            } else { 
                modalRole.style.display = "none"; 
            }
            
            // Instaの表示制御
            if (instaId) { 
                modalInstaArea.style.display = "flex";
                modalInstaName.textContent = instaId; 
                modalInstaLink.href = "https://instagram.com/" + instaId; 
            } else { 
                modalInstaArea.style.display = "none"; 
            }
            
            modal.classList.add('active');
        };
        
        window.closeQrModal = function() { modal.classList.remove('active'); };
        modal.addEventListener('click', (e) => { if (e.target === modal) closeQrModal(); });
        init();
    </script>
</body>
</html>
