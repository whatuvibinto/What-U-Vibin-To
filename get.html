<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GET QR | WHAT U VIBIN TO?</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/index.css"> 
    <link rel="stylesheet" href="css/get.css">
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <a href="index.html" class="logo-link">
                <img src="images/white_logo.png" alt="WHAT U VIBIN TO?" class="header-logo" onerror="this.style.display='none'">
            </a>
        </div>
        </header>

    <main class="form-section">
        <h1 class="form-title">GET YOUR QR</h1>
        <div class="form-container">

            <div class="plan-toggle">
                <button type="button" class="plan-btn active" id="btnFree" onclick="app.setPlan('free')">FREE</button>
                <button type="button" class="plan-btn" id="btnPro" onclick="app.setPlan('pro')">PRO PLAN</button>
            </div>

            <div class="form-group">
                <label class="form-label">DJ NAME</label>
                <input type="text" id="djName" class="form-input" placeholder="Enter Name">
            </div>

            <div class="form-group">
                <label class="form-label">CITY</label>
                <input type="text" id="city" class="form-input" placeholder="City (ex. Tokyo)">
            </div>

            <div class="form-group">
                <label class="form-label">GENRES (Select up to 3)</label>
                <div class="genre-container">
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">House</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Techno</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Hip Hop</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">R&B</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Disco</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Trap</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Bass</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Amapiano</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 30px 0;">

            <div class="form-group">
                <label class="form-label" style="color:#fff">DEFAULT LINK (Required)</label>
                <input type="url" id="linkDefault" class="form-input" placeholder="Spotify / Apple Music URL">
            </div>

            <div id="groupMorning" class="time-link-group locked-section">
                <div class="time-header"><span>MORNING (06:00-11:00)</span></div>
                <input type="url" id="linkMorning" class="form-input" placeholder="Morning URL">
                <input type="hidden" id="timeStartMorning" value="06:00">
                <input type="hidden" id="timeEndMorning" value="11:00">
            </div>

            <div id="groupDaytime" class="time-link-group locked-section">
                <div class="time-header"><span>DAYTIME (11:00-18:00)</span></div>
                <input type="url" id="linkDaytime" class="form-input" placeholder="Daytime URL">
                <input type="hidden" id="timeStartDaytime" value="11:00">
                <input type="hidden" id="timeEndDaytime" value="18:00">
            </div>

            <div id="groupNight" class="time-link-group">
                <div class="time-header"><span style="color:var(--color-neon)">NIGHT (18:00-06:00)</span></div>
                <input type="url" id="linkNight" class="form-input" placeholder="Night URL">
                <div id="nightTimeUI" class="locked-section" style="margin-top:10px;">
                    <div class="time-inputs">
                        <input type="time" id="timeStartNight" value="18:00"> - <input type="time" id="timeEndNight" value="06:00">
                    </div>
                </div>
            </div>

            <div id="exploreGroup" class="toggle-wrapper locked-section">
                <span class="form-label" style="margin:0">SHOW ON EXPLORE</span>
                <label class="switch">
                    <input type="checkbox" id="isPublic">
                    <span class="slider"></span>
                </label>
            </div>

            <button type="button" class="btn-submit" id="btnSubmit" onclick="app.generateQR()">GENERATE QR</button>
            
        </div>
    </main>
    
    <div id="debugConsole">DEBUG LOG START...<br></div>

    <script>
        // ===============================================
        // 設定: ここにSupabaseのキーを入れてください
        // ===============================================
        const CONFIG = {
            url: 'https://zcjzmuzmhuanyauhgeni.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjanptdXptaHVhbnlhdWhnZW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzAyNjAsImV4cCI6MjA4NTQwNjI2MH0.pNB58zLyRR4iM1oYoKeZQcJ1grKyrOY8F-Akd2298-A'
        };

        // ===============================================
        // ログ機能
        // ===============================================
        function log(msg) {
            const consoleBox = document.getElementById('debugConsole');
            if(consoleBox) {
                const time = new Date().toLocaleTimeString();
                consoleBox.innerHTML += `[${time}] ${msg}<br>`;
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
            console.log(msg);
        }

        // ===============================================
        // アプリケーション
        // ===============================================
        const app = {
            currentPlan: 'free',
            selectedGenres: [],

            init: function() {
                log("App Initialized.");
                this.setPlan('free');
            },

            setPlan: function(plan) {
                log("Switching Plan to: " + plan);
                this.currentPlan = plan;
                const btnFree = document.getElementById('btnFree');
                const btnPro = document.getElementById('btnPro');
                
                if(btnFree) btnFree.className = plan === 'free' ? 'plan-btn active' : 'plan-btn';
                if(btnPro) btnPro.className = plan === 'pro' ? 'plan-btn active' : 'plan-btn';
                
                const lockList = ['groupMorning', 'groupDaytime', 'nightTimeUI', 'exploreGroup'];
                lockList.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        if(plan === 'free') el.classList.add('locked-section');
                        else el.classList.remove('locked-section');
                    }
                });
                const publicCheck = document.getElementById('isPublic');
                if(publicCheck) publicCheck.checked = (plan === 'pro');
            },

            toggleGenre: function(btn) {
                const val = btn.innerText;
                if(this.selectedGenres.includes(val)) {
                    this.selectedGenres = this.selectedGenres.filter(g => g !== val);
                    btn.classList.remove('selected');
                } else {
                    if(this.selectedGenres.length >= 3) { alert("Max 3 genres"); return; }
                    this.selectedGenres.push(val);
                    btn.classList.add('selected');
                }
            },

            generateQR: async function() {
                log("Generate Button Clicked.");
                const btn = document.getElementById('btnSubmit');

                if(CONFIG.url.includes('YOUR_')) {
                    alert("APIキーが設定されていません。"); return;
                }

                // 安全な値取得関数
                const getVal = (id) => {
                    const el = document.getElementById(id);
                    if (!el) {
                        log("⚠️ Warning: Element not found -> " + id);
                        return "";
                    }
                    return el.value;
                };

                const name = getVal('djName');
                const link = getVal('linkDefault');
                
                if(!name || !link) { alert("名前とDefault Linkは必須です"); return; }

                btn.disabled = true;
                btn.innerText = "CONNECTING...";

                try {
                    const sb = window.supabase.createClient(CONFIG.url, CONFIG.key);

                    // 1. Profile保存
                    log("Saving Profile...");
                    const { data: prof, error: err1 } = await sb.from('profiles').insert([{
                        dj_name: name,
                        city: getVal('city'),
                        genres: this.selectedGenres,
                        plan: this.currentPlan,
                        is_public: document.getElementById('isPublic') ? document.getElementById('isPublic').checked : false,
                        slug: Math.random().toString(36).slice(-8)
                    }]).select().single();
                    
                    if(err1) throw new Error("Profile Error: " + err1.message);
                    log("Profile Saved ID: " + prof.id);

                    // 2. QR保存
                    log("Saving QR Code...");
                    const { data: qr, error: err2 } = await sb.from('qr_codes').insert([{
                        profile_id: prof.id, 
                        qr_type: this.currentPlan
                    }]).select().single();
                    
                    if(err2) throw new Error("QR Error: " + err2.message);
                    log("QR Saved ID: " + qr.id);

                    // 3. Links保存
                    log("Saving Links...");
                    
                    const saveLink = async (type, url, s, e) => {
                        const payload = { 
                            profile_id: prof.id,
                            time_type: type, 
                            url: url
                        };
                        // 時間がある場合のみ追加（Time型エラー防止のため秒までつける）
                        if(s && e) { 
                            payload.start_time = s.length === 5 ? s + ":00" : s; 
                            payload.end_time = e.length === 5 ? e + ":00" : e; 
                        }

                        const { error } = await sb.from('links').insert([payload]);
                        if(error) throw new Error(`Link Error (${type}): ` + error.message);
                    };

                    // Default Link
                    await saveLink('default', link, null, null);
                    log("Default Link OK");

                    // Other Links
                    if(this.currentPlan === 'pro') {
                        if(getVal('linkMorning')) await saveLink('morning', getVal('linkMorning'), getVal('timeStartMorning'), getVal('timeEndMorning'));
                        if(getVal('linkDaytime')) await saveLink('daytime', getVal('linkDaytime'), getVal('timeStartDaytime'), getVal('timeEndDaytime'));
                    }
                    // Night Link
                    if(getVal('linkNight')) await saveLink('nighttime', getVal('linkNight'), getVal('timeStartNight'), getVal('timeEndNight'));

                    btn.innerText = "SUCCESS!";
                    alert("成功！DBを確認してください。");
                    btn.disabled = false;

                } catch(e) {
                    console.error(e);
                    log("ERROR: " + e.message);
                    alert("エラー発生: " + e.message);
                    btn.disabled = false;
                    btn.innerText = "RETRY";
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
