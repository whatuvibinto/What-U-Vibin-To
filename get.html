<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GET QR | WHAT U VIBIN TO?</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/index.css"> 
    <link rel="stylesheet" href="css/get.css">
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <a href="index.html" class="logo-link">
                <img src="images/white_logo.png" alt="WHAT U VIBIN TO?" class="header-logo" onerror="this.style.display='none'">
            </a>
        </div>
    </header>

    <main class="form-section">
        
        <div class="bg-layer">
            <div class="glow-spot-1"></div>
            <div class="glow-spot-2"></div>
            <div class="glow-bottom"></div>
        </div>

        <h1 class="form-title" id="pageTitle">GET YOUR ”VIBIN QR”</h1>
        <p class="form-subtitle">あなたのバイブスQRをつくる</p>
        
        <div class="form-container" id="formContainer">

            <div class="plan-toggle">
                <button type="button" class="plan-btn active" id="btnFree" onclick="app.setPlan('free')">FREE</button>
                <button type="button" class="plan-btn" id="btnPro" onclick="app.setPlan('pro')">PRO PLAN</button>
            </div>

            <div class="form-group">
                <label class="form-label">DJ NAME</label>
                <input type="text" id="djName" class="form-input" placeholder="Enter Name">
            </div>

            <div class="form-group">
                <label class="form-label">CITY</label>
                <input type="text" id="city" class="form-input" placeholder="City (ex. Tokyo)">
            </div>

            <div class="form-group">
                <label class="form-label">GENRES (Select up to 3)</label>
                <div class="genre-container">
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">House</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Techno</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Hip Hop</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">R&B</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Disco</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Trap</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Bass</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Amapiano</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 30px 0;">

            <div class="form-group">
                <label class="form-label" style="color:#fff">DEFAULT LINK (Required)</label>
                <input type="url" id="linkDefault" class="form-input" placeholder="Spotify / Apple Music URL">
            </div>

            <div id="groupMorning" class="time-link-group locked-section">
                <div class="time-header">
                    <span>MORNING VIBE</span>
                    <div class="time-inputs">
                        <input type="time" id="timeStartMorning" value="06:00">
                        <span class="time-sep">-</span>
                        <input type="time" id="timeEndMorning" value="11:00">
                    </div>
                </div>
                <input type="url" id="linkMorning" class="form-input" placeholder="Morning Playlist URL">
            </div>

            <div id="groupDaytime" class="time-link-group locked-section">
                <div class="time-header">
                    <span>DAYTIME VIBE</span>
                    <div class="time-inputs">
                        <input type="time" id="timeStartDaytime" value="11:00">
                        <span class="time-sep">-</span>
                        <input type="time" id="timeEndDaytime" value="18:00">
                    </div>
                </div>
                <input type="url" id="linkDaytime" class="form-input" placeholder="Daytime Playlist URL">
            </div>

            <div id="groupNight" class="time-link-group">
                <div class="time-header">
                    <span style="color:var(--color-neon)" id="labelNight">NIGHTTIME VIBE</span>
                    <div class="time-inputs locked-section" id="nightTimeUI">
                        <input type="time" id="timeStartNight" value="18:00">
                        <span class="time-sep">-</span>
                        <input type="time" id="timeEndNight" value="06:00">
                    </div>
                </div>
                <input type="url" id="linkNight" class="form-input" placeholder="Night Playlist URL">
            </div>

            <div id="exploreGroup" class="toggle-wrapper locked-section">
                <span class="form-label" style="margin:0">SHOW ON EXPLORE</span>
                <label class="switch">
                    <input type="checkbox" id="isPublic">
                    <span class="slider"></span>
                </label>
            </div>

            <button type="button" class="btn-submit" id="btnSubmit" onclick="app.generateQR()">GENERATE QR</button>
            
        </div>
    </main>

    <script>
        // ===============================================
        // ★★★ 設定: APIキーを入力してください ★★★
        // ===============================================
        const CONFIG = {
            url: 'https://zcjzmuzmhuanyauhgeni.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjanptdXptaHVhbnlhdWhnZW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzAyNjAsImV4cCI6MjA4NTQwNjI2MH0.pNB58zLyRR4iM1oYoKeZQcJ1grKyrOY8F-Akd2298-A'
        };


        const app = {
            currentPlan: 'free',
            selectedGenres: [],

            init: function() {
                this.setPlan('free');
            },

            setPlan: function(plan) {
                this.currentPlan = plan;
                const btnFree = document.getElementById('btnFree');
                const btnPro = document.getElementById('btnPro');
                const container = document.getElementById('formContainer');
                const labelNight = document.getElementById('labelNight');
                
                // ボタンの見た目
                if(btnFree) btnFree.className = plan === 'free' ? 'plan-btn active' : 'plan-btn';
                if(btnPro) btnPro.className = plan === 'pro' ? 'plan-btn active' : 'plan-btn';
                
                // ★ Gold Effect
                if(plan === 'pro') {
                    container.classList.add('gold-border', 'pro-mode');
                    labelNight.style.color = '#FFD700'; // Gold
                } else {
                    container.classList.remove('gold-border', 'pro-mode');
                    labelNight.style.color = '#a855f7'; // Neon Purple
                }

                // ロック制御
                const lockList = ['groupMorning', 'groupDaytime', 'nightTimeUI', 'exploreGroup'];
                lockList.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        if(plan === 'free') el.classList.add('locked-section');
                        else el.classList.remove('locked-section');
                    }
                });
                
                // チェックボックスの制御
                const publicCheck = document.getElementById('isPublic');
                if(publicCheck) publicCheck.checked = (plan === 'pro');

                // Reset Logic (Freeに戻したらPro専用データを消す)
                if(plan === 'free') {
                    const clearVal = (id) => { 
                        const el = document.getElementById(id); 
                        if(el) el.value = ""; 
                    };
                    clearVal('linkMorning');
                    clearVal('linkDaytime');
                }
            },

            toggleGenre: function(btn) {
                const val = btn.innerText;
                if(this.selectedGenres.includes(val)) {
                    this.selectedGenres = this.selectedGenres.filter(g => g !== val);
                    btn.classList.remove('selected');
                } else {
                    if(this.selectedGenres.length >= 3) { alert("Max 3 genres"); return; }
                    this.selectedGenres.push(val);
                    btn.classList.add('selected');
                }
            },

            generateQR: async function() {
                const btn = document.getElementById('btnSubmit');

                if(CONFIG.url.includes('YOUR_')) {
                    alert("APIキーが設定されていません。"); return;
                }

                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : "";
                };

                const name = getVal('djName');
                const link = getVal('linkDefault');
                
                if(!name || !link) { alert("DJ NameとDefault Linkは必須です"); return; }

                btn.disabled = true;
                btn.innerText = "CONNECTING...";

                try {
                    const sb = window.supabase.createClient(CONFIG.url, CONFIG.key);

                    // 1. Profile保存
                    const { data: prof, error: err1 } = await sb.from('profiles').insert([{
                        dj_name: name,
                        city: getVal('city'),
                        genres: this.selectedGenres,
                        plan: this.currentPlan,
                        is_public: document.getElementById('isPublic') ? document.getElementById('isPublic').checked : false,
                        slug: Math.random().toString(36).slice(-8)
                    }]).select().single();
                    
                    if(err1) throw new Error("Profile Error: " + err1.message);

                    // 2. QR保存
                    const { data: qr, error: err2 } = await sb.from('qr_codes').insert([{
                        profile_id: prof.id, 
                        qr_type: this.currentPlan
                    }]).select().single();
                    
                    if(err2) throw new Error("QR Error: " + err2.message);

                    // 3. Links保存
                    const saveLink = async (type, url, s, e) => {
                        const payload = { 
                            profile_id: prof.id,
                            time_type: type, 
                            url: url
                        };
                        if(s && e) { 
                            payload.start_time = s.length === 5 ? s + ":00" : s; 
                            payload.end_time = e.length === 5 ? e + ":00" : e; 
                        }
                        const { error } = await sb.from('links').insert([payload]);
                        if(error) throw new Error(`Link Error (${type}): ` + error.message);
                    };

                    await saveLink('default', link, null, null);

                    if(this.currentPlan === 'pro') {
                        if(getVal('linkMorning')) await saveLink('morning', getVal('linkMorning'), getVal('timeStartMorning'), getVal('timeEndMorning'));
                        if(getVal('linkDaytime')) await saveLink('daytime', getVal('linkDaytime'), getVal('timeStartDaytime'), getVal('timeEndDaytime'));
                    }
                    if(getVal('linkNight')) await saveLink('nighttime', getVal('linkNight'), getVal('timeStartNight'), getVal('timeEndNight'));

                    btn.innerText = "SUCCESS!";
                    alert("登録完了！" + (this.currentPlan === 'pro' ? "Pro機能が適用されました。" : ""));
                    btn.disabled = false;
                    btn.innerText = "GENERATE QR";

                } catch(e) {
                    console.error(e);
                    alert("エラー: " + e.message);
                    btn.disabled = false;
                    btn.innerText = "RETRY";
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
