<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GET QR | WHAT U VIBIN TO?</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/index.css"> 
    <link rel="stylesheet" href="css/get.css">
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <a href="index.html" class="logo-link">
                <img src="images/white_logo.png" alt="WHAT U VIBIN TO?" class="header-logo" onerror="this.style.display='none'">
            </a>
        </div>
        <button class="menu-btn" id="menuBtn" aria-label="Menu"><span></span><span></span><span></span></button>
    </header>

    <div id="menuPanel" class="menu-panel">
        <nav class="menu-nav">
            <a href="index.html" class="nav-link" onclick="closeMenu()"><span class="nav-en">Home</span><span class="nav-jp">トップページに戻る</span></a>
            <a href="explore.html" class="nav-link" onclick="closeMenu()"><span class="nav-en">Explore</span><span class="nav-jp">あの人の"この時間"をのぞく</span></a>
            <a href="how.html" class="nav-link" onclick="closeMenu()"><span class="nav-en">How it works</span><span class="nav-jp">仕組み / 使い方</span></a>
            <a href="get.html" class="nav-link highlight" onclick="closeMenu()"><span class="nav-en">Get QR</span><span class="nav-jp">あなただけのQRをつくる</span></a>
        </nav>
    </div>

    <main class="form-section">
        <div class="bg-layer">
            <div class="glow-spot-1"></div>
            <div class="glow-spot-2"></div>
            <div class="glow-bottom"></div>
        </div>

        <h1 class="form-title" id="pageTitle">GET YOUR ”VIBIN QR”</h1>
        <p class="form-subtitle">あなたのバイブスQRをつくる</p>
        
        <div class="form-container" id="formContainer">

            <div class="plan-toggle">
                <button type="button" class="plan-btn active" id="btnFree" onclick="app.setPlan('free')">FREE</button>
                <button type="button" class="plan-btn" id="btnPro" onclick="app.setPlan('pro')">PRO PLAN</button>
            </div>

            <div class="form-group">
                <label class="form-label">DJ NAME</label>
                <input type="text" id="djName" class="form-input" placeholder="Enter Name">
            </div>
            <div class="form-group">
                <label class="form-label">CITY</label>
                <input type="text" id="city" class="form-input" placeholder="City (ex. Tokyo)">
            </div>
            <div class="form-group">
                <label class="form-label">GENRES (Select up to 3)</label>
                <div class="genre-container">
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">House</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Techno</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Hip Hop</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">R&B</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Disco</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Trap</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Bass</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Amapiano</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 30px 0;">

            <div class="form-group">
                <label class="form-label" style="color:#fff">DEFAULT LINK (Required)</label>
                <input type="url" id="linkDefault" class="form-input" placeholder="Spotify / Apple Music URL">
            </div>

            <div id="groupMorning" class="time-link-group locked-section">
                <div class="time-header">
                    <span id="labelMorning">MORNING VIBE</span>
                    <div class="time-inputs"><input type="time" id="timeStartMorning" value="06:00"><span class="time-sep">-</span><input type="time" id="timeEndMorning" value="11:00"></div>
                </div>
                <input type="url" id="linkMorning" class="form-input" placeholder="Morning Playlist URL">
            </div>

            <div id="groupDaytime" class="time-link-group locked-section">
                <div class="time-header">
                    <span id="labelDaytime">DAYTIME VIBE</span>
                    <div class="time-inputs"><input type="time" id="timeStartDaytime" value="11:00"><span class="time-sep">-</span><input type="time" id="timeEndDaytime" value="18:00"></div>
                </div>
                <input type="url" id="linkDaytime" class="form-input" placeholder="Daytime Playlist URL">
            </div>

            <div id="groupNight" class="time-link-group">
                <div class="time-header">
                    <span style="color:var(--color-neon)" id="labelNight">NIGHTTIME VIBE</span>
                    <div class="time-inputs locked-section" id="nightTimeUI"><input type="time" id="timeStartNight" value="18:00"><span class="time-sep">-</span><input type="time" id="timeEndNight" value="06:00"></div>
                </div>
                <input type="url" id="linkNight" class="form-input" placeholder="Night Playlist URL">
            </div>

            <div id="exploreGroup" class="toggle-wrapper locked-section">
                <span class="form-label" style="margin:0">SHOW ON EXPLORE</span>
                <label class="switch"><input type="checkbox" id="isPublic" onchange="app.toggleExplore()"><span class="slider"></span></label>
            </div>

            <div id="exploreDetails" class="explore-details">
                <div class="form-group">
                    <label class="form-label">PROFILE IMAGE</label>
                    <label class="file-upload-btn">
                        <input type="file" id="profileImage" accept="image/*" style="display:none" onchange="app.handleProfileImage(this)">
                        <span id="profileImageLabel">Click to Upload Image</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">INSTAGRAM ID</label>
                    <input type="text" id="instaId" class="form-input" placeholder="@username">
                </div>
                <div class="form-group">
                    <label class="form-label">CARD THEME COLOR</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-opt selected" style="background:#a855f7" data-color="#a855f7" onclick="app.selectColor(this)"></div>
                        <div class="color-opt" style="background:#3b82f6" data-color="#3b82f6" onclick="app.selectColor(this)"></div>
                        <div class="color-opt" style="background:#ef4444" data-color="#ef4444" onclick="app.selectColor(this)"></div>
                        <div class="color-opt" style="background:#22c55e" data-color="#22c55e" onclick="app.selectColor(this)"></div>
                        <div class="color-opt" style="background:#f59e0b" data-color="#f59e0b" onclick="app.selectColor(this)"></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <div id="qrPreviewArea" class="qr-preview-area hidden">
                    <div id="loadingOverlay" class="loading-overlay">
                        <div class="spinner"></div>
                        <div class="loading-text">GENERATING...</div>
                    </div>
                    
                    <div class="preview-text">SELECT YOUR STYLE</div>
                    
                    <div class="preview-grid">
                        <div class="design-btn active" data-type="A" id="btnA" onclick="app.selectDesign('A')">
                            <div class="style-preview-box" id="canvas-A"></div>
                            <span class="design-name">Standard</span>
                        </div>
                        <div class="design-btn locked" data-type="B" id="btnB" onclick="app.selectDesign('B')">
                            <div class="style-preview-box" id="canvas-B"></div>
                            <span class="design-name">Modern</span>
                        </div>
                        <div class="design-btn locked" data-type="C" id="btnC" onclick="app.selectDesign('C')">
                            <div class="style-preview-box" id="canvas-C"></div>
                            <span class="design-name">Dot</span>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn-preview" onclick="app.previewQR()">PREVIEW QR</button>
                <button type="button" class="btn-submit" id="btnSubmit" onclick="app.generateQR()">GENERATE QR</button>
            </div>
            
        </div>

        <div id="resultModal" class="result-modal">
            <div class="result-content" id="resultContent">
                <h2 class="result-title">QR CODE GENERATED</h2>
                
                <div class="result-image-box">
                    <img id="finalQrImage" src="" alt="Generated QR">
                </div>

                <div class="result-actions">
                    <button type="button" class="btn-download" onclick="app.downloadQR()">
                        <span>⬇ DOWNLOAD IMAGE</span>
                    </button>
                    <button type="button" class="btn-close" onclick="app.closeResult()">CLOSE</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // ===============================================
        // ★★★ 設定: APIキーを入力してください ★★★
        // ===============================================
        const CONFIG = {
            url: 'https://zcjzmuzmhuanyauhgeni.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjanptdXptaHVhbnlhdWhnZW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzAyNjAsImV4cCI6MjA4NTQwNjI2MH0.pNB58zLyRR4iM1oYoKeZQcJ1grKyrOY8F-Akd2298-A'
        };

        const LOGO_PATH = "images/qr_logo.PNG"; 
        
        // ★遷移先を qr_links.html に修正済み
        const path = window.location.pathname;
        const dir = path.substring(0, path.lastIndexOf('/'));
        const directory = dir.endsWith('/') ? dir : dir + '/';
        const BASE_URL = window.location.origin + directory + 'qr_links.html?id=';

        // --- Menu Logic ---
        const menuBtn = document.getElementById('menuBtn');
        const menuPanel = document.getElementById('menuPanel');
        let isMenuOpen = false;
        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) { menuPanel.classList.add('menu-open'); menuBtn.classList.add('active'); document.body.style.overflow = 'hidden'; }
            else { closeMenu(); }
        }
        function closeMenu() {
            isMenuOpen = false; menuPanel.classList.remove('menu-open'); menuBtn.classList.remove('active'); document.body.style.overflow = 'auto';
        }
        if(menuBtn) menuBtn.addEventListener('click', toggleMenu);

        // --- App Logic ---
        const app = {
            currentPlan: 'free',
            currentDesign: 'A',
            selectedGenres: [],
            profileFile: null,
            selectedColor: '#a855f7',
            qrCodeObj: null, // 生成後に保持するオブジェクト
            
            // デザイン定義 (ロゴサイズ0.3, 背景黒, QR白)
            styles: {
                A: { 
                    dots: { type: 'square', color: '#ffffff' }, 
                    cornersSq: { type: 'square', color: '#ffffff' }, 
                    cornersDot: { type: 'square', color: '#ffffff' },
                    bg: { color: '#000000' }
                },
                B: { 
                    dots: { type: 'extra-rounded', color: '#ffffff' }, 
                    cornersSq: { type: 'extra-rounded', color: '#ffffff' }, 
                    cornersDot: { type: 'rounded', color: '#ffffff' },
                    bg: { color: '#000000' }
                },
                C: { 
                    dots: { type: 'rounded', color: '#ffffff' }, 
                    cornersSq: { type: 'dot', color: '#ffffff' }, 
                    cornersDot: { type: 'dot', color: '#ffffff' }, 
                    bg: { color: '#000000' }
                }
            },

            init: function() {
                this.setPlan('free');
            },

            setPlan: function(plan) {
                this.currentPlan = plan;
                const btnFree = document.getElementById('btnFree');
                const btnPro = document.getElementById('btnPro');
                const container = document.getElementById('formContainer');
                
                const labelMorning = document.getElementById('labelMorning');
                const labelDaytime = document.getElementById('labelDaytime');
                const labelNight = document.getElementById('labelNight');
                
                // Style Buttons
                const btnB = document.getElementById('btnB');
                const btnC = document.getElementById('btnC');
                
                if(btnFree) btnFree.className = plan === 'free' ? 'plan-btn active' : 'plan-btn';
                if(btnPro) btnPro.className = plan === 'pro' ? 'plan-btn active' : 'plan-btn';
                
                if(plan === 'pro') {
                    container.classList.add('gold-border', 'pro-mode');
                    labelMorning.style.color = '#FFD700'; 
                    labelDaytime.style.color = '#FFD700'; 
                    labelNight.style.color = '#FFD700';
                    // Unlock styles
                    if(btnB) btnB.classList.remove('locked');
                    if(btnC) btnC.classList.remove('locked');
                } else {
                    container.classList.remove('gold-border', 'pro-mode');
                    labelMorning.style.color = '#fff';      
                    labelDaytime.style.color = '#fff';      
                    labelNight.style.color = '#a855f7';
                    // Lock styles
                    if(btnB) btnB.classList.add('locked');
                    if(btnC) btnC.classList.add('locked');
                    this.selectDesign('A');
                }

                const lockList = ['groupMorning', 'groupDaytime', 'nightTimeUI', 'exploreGroup'];
                lockList.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        if(plan === 'free') el.classList.add('locked-section');
                        else el.classList.remove('locked-section');
                    }
                });
                
                const publicCheck = document.getElementById('isPublic');
                if(publicCheck) {
                    publicCheck.checked = (plan === 'pro');
                    this.toggleExplore(); // Refresh explore visibility
                }

                if(plan === 'free') {
                    const clearVal = (id) => { const el = document.getElementById(id); if(el) el.value = ""; };
                    clearVal('linkMorning'); clearVal('linkDaytime');
                }
            },

            toggleGenre: function(btn) {
                const val = btn.innerText;
                if(this.selectedGenres.includes(val)) {
                    this.selectedGenres = this.selectedGenres.filter(g => g !== val);
                    btn.classList.remove('selected');
                } else {
                    if(this.selectedGenres.length >= 3) { alert("Max 3 genres"); return; }
                    this.selectedGenres.push(val);
                    btn.classList.add('selected');
                }
            },

            // --- Explore Features ---
            toggleExplore: function() {
                const isChecked = document.getElementById('isPublic').checked;
                const details = document.getElementById('exploreDetails');
                if(isChecked) details.classList.add('open');
                else details.classList.remove('open');
            },

            handleProfileImage: function(input) {
                if(input.files && input.files[0]) {
                    this.profileFile = input.files[0];
                    document.getElementById('profileImageLabel').innerText = "Selected: " + this.profileFile.name;
                }
            },

            selectColor: function(el) {
                document.querySelectorAll('.color-opt').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                this.selectedColor = el.getAttribute('data-color');
            },

            // --- QR Logic ---
            selectDesign: function(type) {
                if(this.currentPlan === 'free' && type !== 'A') return;

                this.currentDesign = type;
                
                // ボタンの選択状態更新
                document.querySelectorAll('.design-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if(btn.dataset.type === type) btn.classList.add('active');
                });
            },

            // ★ プレビュー：ボタンの中に3つのQRを描画する
            previewQR: function() {
                const link = document.getElementById('linkDefault').value;
                if(!link) { alert("Default Linkを入力してください"); return; }
                if(typeof QRCodeStyling === 'undefined') { alert("QR Library Error"); return; }

                const previewArea = document.getElementById('qrPreviewArea');
                const loading = document.getElementById('loadingOverlay');
                
                previewArea.classList.remove('hidden');
                loading.classList.add('visible');

                setTimeout(() => {
                    try {
                        // 3種類すべて描画
                        ['A', 'B', 'C'].forEach(type => {
                            const box = document.getElementById('canvas-' + type);
                            if(box) {
                                box.innerHTML = "";
                                const style = this.styles[type];
                                const qr = new QRCodeStyling({
                                    width: 150, height: 150,
                                    type: "canvas",
                                    data: BASE_URL + "PREVIEW",
                                    image: LOGO_PATH,
                                    qrOptions: { errorCorrectionLevel: "Q" },
                                    imageOptions: { crossOrigin: "anonymous", margin: 2, imageSize: 0.3, hideBackgroundDots: true },
                                    dotsOptions: style.dots,
                                    cornersSquareOptions: style.cornersSq,
                                    cornersDotOptions: style.cornersDot,
                                    backgroundOptions: style.bg
                                });
                                qr.append(box);
                            }
                        });
                        
                        // 選択状態の反映
                        this.selectDesign(this.currentDesign);

                    } catch(e) {
                        console.error("Preview Error:", e);
                        alert("プレビュー生成に失敗しました。");
                    } finally {
                        setTimeout(() => {
                            loading.classList.remove('visible');
                        }, 500); 
                    }
                }, 200);
            },

            // ★ ダウンロード機能
            downloadQR: function() {
                if(this.qrCodeObj) {
                    this.qrCodeObj.download({ name: "my_vibe_qr", extension: "png" });
                }
            },

            // ★ モーダルを閉じる
            closeResult: function() {
                document.getElementById('resultModal').classList.remove('visible');
                window.location.reload(); // リセットのためリロード
            },

            generateQR: async function() {
                const btn = document.getElementById('btnSubmit');
                if(CONFIG.url.includes('YOUR_')) { alert("APIキーが設定されていません。"); return; }

                const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
                const name = getVal('djName');
                const link = getVal('linkDefault');
                
                if(!name || !link) { alert("DJ NameとDefault Linkは必須です"); return; }

                btn.disabled = true;
                btn.innerText = "UPLOADING...";

                try {
                    const sb = window.supabase.createClient(CONFIG.url, CONFIG.key);
                    
                    // 1. プロフィール画像アップロード (Bucket: user_images)
                    let imageUrl = "";
                    if(this.profileFile) {
                        const fileExt = this.profileFile.name.split('.').pop();
                        const fileName = `image_${Date.now()}.${fileExt}`;
                        const { error: upErr } = await sb.storage.from('user_images').upload(fileName, this.profileFile);
                        if(!upErr) {
                            const { data: pubUrl } = sb.storage.from('user_images').getPublicUrl(fileName);
                            imageUrl = pubUrl.publicUrl;
                        }
                    }

                    // 2. Profile保存
                    const profileData = {
                        dj_name: name,
                        city: getVal('city'),
                        genres: this.selectedGenres,
                        plan: this.currentPlan,
                        is_public: document.getElementById('isPublic') ? document.getElementById('isPublic').checked : false,
                        slug: Math.random().toString(36).slice(-8),
                        instagram_id: getVal('instaId'),
                        color: this.selectedColor, 
                        image_url: imageUrl 
                    };

                    const { data: prof, error: err1 } = await sb.from('profiles').insert([profileData]).select().single();
                    if(err1) throw new Error("Profile Error: " + err1.message);

                    // 3. Links保存
                    const saveLink = async (type, url, s, e) => {
                        const payload = { profile_id: prof.id, time_type: type, url: url };
                        if(s && e) { payload.start_time = s.length === 5 ? s+":00" : s; payload.end_time = e.length === 5 ? e+":00" : e; }
                        await sb.from('links').insert([payload]);
                    };

                    await saveLink('default', link, null, null);

                    if(this.currentPlan === 'pro') {
                        if(getVal('linkMorning')) await saveLink('morning', getVal('linkMorning'), getVal('timeStartMorning'), getVal('timeEndMorning'));
                        if(getVal('linkDaytime')) await saveLink('daytime', getVal('linkDaytime'), getVal('timeStartDaytime'), getVal('timeEndDaytime'));
                    }
                    if(getVal('linkNight')) await saveLink('nighttime', getVal('linkNight'), getVal('timeStartNight'), getVal('timeEndNight'));

                    // 4. QRコード生成（本番データ）
                    const finalUrl = BASE_URL + prof.id; 
                    const style = this.styles[this.currentDesign];

                    this.qrCodeObj = new QRCodeStyling({
                        width: 500, height: 500, // 高画質用
                        type: "canvas",
                        data: finalUrl,
                        image: LOGO_PATH,
                        qrOptions: { errorCorrectionLevel: "Q" },
                        imageOptions: { crossOrigin: "anonymous", margin: 2, imageSize: 0.3, hideBackgroundDots: true },
                        dotsOptions: style.dots,
                        cornersSquareOptions: style.cornersSq,
                        cornersDotOptions: style.cornersDot,
                        backgroundOptions: style.bg
                    });

                    // 5. Blob変換 & Storageアップロード (Bucket: qr_images)
                    const qrBlob = await this.qrCodeObj.getRawData('png');
                    const qrFileName = `qr_${prof.id}.png`;
                    
                    const { error: qrUpErr } = await sb.storage.from('qr_images').upload(qrFileName, qrBlob, {
                        contentType: 'image/png'
                    });
                    
                    let qrStorageUrl = "";
                    if(!qrUpErr) {
                        const { data: qrPub } = sb.storage.from('qr_images').getPublicUrl(qrFileName);
                        qrStorageUrl = qrPub.publicUrl;
                    }

                    // 6. DBへQR情報保存 (qr_image_url)
                    const { error: err2 } = await sb.from('qr_codes').insert([{
                        profile_id: prof.id, 
                        qr_type: this.currentPlan,
                        design_type: this.currentDesign,
                        logo_url: LOGO_PATH,
                        qr_image_url: qrStorageUrl // ★変更済みのカラム名
                    }]);
                    if(err2) console.error("QR DB Error:", err2);

                    // 7. 成功モーダル表示
                    const localQrUrl = URL.createObjectURL(qrBlob);
                    document.getElementById('finalQrImage').src = localQrUrl;
                    
                    const modalContent = document.getElementById('resultContent');
                    if(this.currentPlan === 'pro') modalContent.parentElement.classList.add('gold-border');
                    else modalContent.parentElement.classList.remove('gold-border');

                    document.getElementById('resultModal').classList.add('visible');
                    btn.innerText = "SUCCESS!";
                    btn.disabled = false;

                } catch(e) {
                    console.error(e);
                    alert("エラー: " + e.message);
                    btn.disabled = false;
                    btn.innerText = "RETRY";
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
