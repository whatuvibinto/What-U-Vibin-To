<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GET QR | WHAT U VIBIN TO?</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/index.css"> 
    <link rel="stylesheet" href="css/get.css">
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <a href="index.html" class="logo-link">
                <img src="images/white_logo.png" alt="WHAT U VIBIN TO?" class="header-logo" onerror="this.style.display='none'">
            </a>
        </div>
        <button class="menu-btn" id="menuBtn" aria-label="Menu"><span></span><span></span><span></span></button>
    </header>

    <div id="menuPanel" class="menu-panel">
        <nav class="menu-nav">
            <a href="index.html" class="nav-link" onclick="closeMenu()"><span class="nav-en">Home</span><span class="nav-jp">トップページに戻る</span></a>
            <a href="explore.html" class="nav-link" onclick="closeMenu()"><span class="nav-en">Explore</span><span class="nav-jp">あの人の"この時間"をのぞく</span></a>
            <a href="how.html" class="nav-link" onclick="closeMenu()"><span class="nav-en">How it works</span><span class="nav-jp">仕組み / 使い方</span></a>
            <a href="get.html" class="nav-link highlight" onclick="closeMenu()"><span class="nav-en">Get QR</span><span class="nav-jp">あなただけのQRをつくる</span></a>
        </nav>
    </div>

    <main class="form-section">
        <div class="bg-layer">
            <div class="glow-spot-1"></div>
            <div class="glow-spot-2"></div>
            <div class="glow-bottom"></div>
        </div>

        <h1 class="form-title" id="pageTitle">GET YOUR ”VIBIN QR”</h1>
        <p class="form-subtitle">あなたのバイブスQRをつくる</p>
        
        <div class="form-container" id="formContainer">

            <div class="plan-toggle">
                <button type="button" class="plan-btn active" id="btnFree" onclick="app.setPlan('free')">FREE</button>
                <button type="button" class="plan-btn" id="btnPro" onclick="app.setPlan('pro')">PRO PLAN</button>
            </div>

            <div class="form-group">
                <label class="form-label">DJ NAME</label>
                <input type="text" id="djName" class="form-input" placeholder="Enter Name">
            </div>
            <div class="form-group">
                <label class="form-label">CITY</label>
                <input type="text" id="city" class="form-input" placeholder="City (ex. Tokyo)">
            </div>
            <div class="form-group">
                <label class="form-label">GENRES (Select up to 3)</label>
                <div class="genre-container">
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">House</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Techno</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Hip Hop</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">R&B</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Disco</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Trap</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Bass</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Amapiano</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 30px 0;">

            <div class="form-group">
                <label class="form-label" style="color:#fff">DEFAULT LINK (Required)</label>
                <input type="url" id="linkDefault" class="form-input" placeholder="Spotify / Apple Music URL">
            </div>

            <div id="groupMorning" class="time-link-group locked-section">
                <div class="time-header">
                    <span id="labelMorning">MORNING VIBE</span>
                    <div class="time-inputs"><input type="time" id="timeStartMorning" value="06:00"><span class="time-sep">-</span><input type="time" id="timeEndMorning" value="11:00"></div>
                </div>
                <input type="url" id="linkMorning" class="form-input" placeholder="Morning Playlist URL">
            </div>

            <div id="groupDaytime" class="time-link-group locked-section">
                <div class="time-header">
                    <span id="labelDaytime">DAYTIME VIBE</span>
                    <div class="time-inputs"><input type="time" id="timeStartDaytime" value="11:00"><span class="time-sep">-</span><input type="time" id="timeEndDaytime" value="18:00"></div>
                </div>
                <input type="url" id="linkDaytime" class="form-input" placeholder="Daytime Playlist URL">
            </div>

            <div id="groupNight" class="time-link-group">
                <div class="time-header">
                    <span style="color:var(--color-neon)" id="labelNight">NIGHTTIME VIBE</span>
                    <div class="time-inputs locked-section" id="nightTimeUI"><input type="time" id="timeStartNight" value="18:00"><span class="time-sep">-</span><input type="time" id="timeEndNight" value="06:00"></div>
                </div>
                <input type="url" id="linkNight" class="form-input" placeholder="Night Playlist URL">
            </div>

            <div style="margin-top: 40px;">
                <span class="design-selector-label">QR STYLE SELECTOR</span>
                <div class="design-options">
                    <div class="design-btn active" data-type="A" onclick="app.selectDesign('A')">
                        <div class="design-icon"></div>
                        <span class="design-name">Standard</span>
                    </div>
                    <div class="design-btn locked" id="designBtnB" data-type="B" onclick="app.selectDesign('B')">
                        <div class="design-icon"></div>
                        <span class="design-name">Modern</span>
                    </div>
                    <div class="design-btn locked" id="designBtnC" data-type="C" onclick="app.selectDesign('C')">
                        <div class="design-icon"></div>
                        <span class="design-name">Dot</span> </div>
                </div>
            </div>

            <div id="exploreGroup" class="toggle-wrapper locked-section">
                <span class="form-label" style="margin:0">SHOW ON EXPLORE</span>
                <label class="switch"><input type="checkbox" id="isPublic"><span class="slider"></span></label>
            </div>

            <div style="margin-top: 40px;">
                <div id="qrPreviewArea" class="qr-preview-area hidden">
                    <div id="loadingOverlay" class="loading-overlay">
                        <div class="spinner"></div>
                        <div class="loading-text">GENERATING...</div>
                    </div>
                    <div class="preview-text">QR PREVIEW (3 STYLES)</div>
                    <div class="preview-grid">
                        <div class="preview-card" id="card-A">
                            <div id="canvas-A"></div>
                            <span class="preview-label">Standard</span>
                        </div>
                        <div class="preview-card" id="card-B">
                            <div id="canvas-B"></div>
                            <span class="preview-label">Modern</span>
                        </div>
                        <div class="preview-card" id="card-C">
                            <div id="canvas-C"></div>
                            <span class="preview-label">Dot</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-preview" onclick="app.previewQR()">PREVIEW QR</button>
                <button type="button" class="btn-submit" id="btnSubmit" onclick="app.generateQR()">GENERATE QR</button>
            </div>
            
        </div>
    </main>

    <script>
        const CONFIG = {
            url: 'YOUR_SUPABASE_URL', 
            key: 'YOUR_ANON_KEY'      
        };

        const LOGO_PATH = "images/qr_logo.PNG"; 
        const BASE_URL = window.location.href.replace('get.html', 'index.html?id=');

        const menuBtn = document.getElementById('menuBtn');
        const menuPanel = document.getElementById('menuPanel');
        let isMenuOpen = false;
        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) { menuPanel.classList.add('menu-open'); menuBtn.classList.add('active'); document.body.style.overflow = 'hidden'; }
            else { closeMenu(); }
        }
        function closeMenu() {
            isMenuOpen = false; menuPanel.classList.remove('menu-open'); menuBtn.classList.remove('active'); document.body.style.overflow = 'auto';
        }
        if(menuBtn) menuBtn.addEventListener('click', toggleMenu);

        // --- App Logic ---
        const app = {
            currentPlan: 'free',
            currentDesign: 'A',
            selectedGenres: [],
            
            // ★デザイン定義 (ロゴサイズ 0.3)
            styles: {
                A: { 
                    dots: { type: 'square', color: '#ffffff' }, 
                    cornersSq: { type: 'square', color: '#ffffff' }, 
                    cornersDot: { type: 'square', color: '#ffffff' },
                    bg: { color: '#000000' }
                },
                B: { 
                    dots: { type: 'extra-rounded', color: '#ffffff' }, 
                    cornersSq: { type: 'extra-rounded', color: '#ffffff' }, 
                    cornersDot: { type: 'rounded', color: '#ffffff' },
                    bg: { color: '#000000' }
                },
                C: { 
                    // Edgy改めDot: にじみを避けるため "rounded" に変更
                    dots: { type: 'dot', color: '#ffffff' }, 
                    cornersSq: { type: 'dot', color: '#ffffff' }, 
                    cornersDot: { type: 'dot', color: '#ffffff' }, 
                    bg: { color: '#000000' }
                }
            },

            init: function() {
                this.setPlan('free');
            },

            setPlan: function(plan) {
                this.currentPlan = plan;
                const btnFree = document.getElementById('btnFree');
                const btnPro = document.getElementById('btnPro');
                const container = document.getElementById('formContainer');
                
                const labelMorning = document.getElementById('labelMorning');
                const labelDaytime = document.getElementById('labelDaytime');
                const labelNight = document.getElementById('labelNight');
                const desB = document.getElementById('designBtnB');
                const desC = document.getElementById('designBtnC');
                
                if(btnFree) btnFree.className = plan === 'free' ? 'plan-btn active' : 'plan-btn';
                if(btnPro) btnPro.className = plan === 'pro' ? 'plan-btn active' : 'plan-btn';
                
                if(plan === 'pro') {
                    container.classList.add('gold-border', 'pro-mode');
                    labelMorning.style.color = '#FFD700'; 
                    labelDaytime.style.color = '#FFD700'; 
                    labelNight.style.color = '#FFD700';
                    desB.classList.remove('locked');
                    desC.classList.remove('locked');
                } else {
                    container.classList.remove('gold-border', 'pro-mode');
                    labelMorning.style.color = '#fff';      
                    labelDaytime.style.color = '#fff';      
                    labelNight.style.color = '#a855f7';
                    desB.classList.add('locked');
                    desC.classList.add('locked');
                    this.selectDesign('A');
                }

                const lockList = ['groupMorning', 'groupDaytime', 'nightTimeUI', 'exploreGroup'];
                lockList.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        if(plan === 'free') el.classList.add('locked-section');
                        else el.classList.remove('locked-section');
                    }
                });
                const publicCheck = document.getElementById('isPublic');
                if(publicCheck) publicCheck.checked = (plan === 'pro');

                if(plan === 'free') {
                    const clearVal = (id) => { const el = document.getElementById(id); if(el) el.value = ""; };
                    clearVal('linkMorning'); clearVal('linkDaytime');
                }
            },

            toggleGenre: function(btn) {
                const val = btn.innerText;
                if(this.selectedGenres.includes(val)) {
                    this.selectedGenres = this.selectedGenres.filter(g => g !== val);
                    btn.classList.remove('selected');
                } else {
                    if(this.selectedGenres.length >= 3) { alert("Max 3 genres"); return; }
                    this.selectedGenres.push(val);
                    btn.classList.add('selected');
                }
            },

            selectDesign: function(type) {
                if(this.currentPlan === 'free' && type !== 'A') return;
                this.currentDesign = type;
                document.querySelectorAll('.design-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if(btn.dataset.type === type) btn.classList.add('active');
                });
                
                // プレビュー表示中なら、選択したカードをハイライト
                this.highlightSelectedPreview();
            },

            highlightSelectedPreview: function() {
                ['A', 'B', 'C'].forEach(t => {
                    const card = document.getElementById('card-' + t);
                    if(card) {
                        if(t === this.currentDesign) card.classList.add('selected-card');
                        else card.classList.remove('selected-card');
                    }
                });
            },

            // ★プレビュー機能 (3つのQRを並べて表示)
            previewQR: function() {
                const link = document.getElementById('linkDefault').value;
                if(!link) { alert("Default Linkを入力してください"); return; }
                if(typeof QRCodeStyling === 'undefined') { alert("QR Library Error"); return; }

                const previewArea = document.getElementById('qrPreviewArea');
                const loading = document.getElementById('loadingOverlay');
                
                previewArea.classList.remove('hidden');
                loading.classList.add('visible');

                setTimeout(() => {
                    try {
                        // 3種類のQRを生成して描画
                        ['A', 'B', 'C'].forEach(type => {
                            const box = document.getElementById('canvas-' + type);
                            if(box) {
                                box.innerHTML = "";
                                const style = this.styles[type];
                                
                                const qr = new QRCodeStyling({
                                    width: 150, height: 150, // プレビュー用サイズ
                                    type: "canvas",
                                    data: BASE_URL + "PREVIEW",
                                    image: LOGO_PATH,
                                    qrOptions: { errorCorrectionLevel: "Q" },
                                    imageOptions: { 
                                        crossOrigin: "anonymous", 
                                        margin: 2, 
                                        imageSize: 0.3, // ★ロゴサイズ縮小 0.3
                                        hideBackgroundDots: true 
                                    },
                                    dotsOptions: style.dots,
                                    cornersSquareOptions: style.cornersSq,
                                    cornersDotOptions: style.cornersDot,
                                    backgroundOptions: style.bg
                                });
                                qr.append(box);
                            }
                        });

                        // 選択中のデザインをハイライト
                        this.highlightSelectedPreview();
                        
                    } catch(e) {
                        console.error("Preview Error:", e);
                        alert("プレビュー生成に失敗しました。画像のパスを確認してください。");
                    } finally {
                        setTimeout(() => {
                            loading.classList.remove('visible');
                        }, 500); 
                    }
                }, 200);
            },

            // ★生成処理 (選択されたデザインで保存)
            generateQR: async function() {
                const btn = document.getElementById('btnSubmit');
                if(CONFIG.url.includes('YOUR_')) { alert("APIキーが設定されていません。"); return; }

                const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
                const name = getVal('djName');
                const link = getVal('linkDefault');
                
                if(!name || !link) { alert("DJ NameとDefault Linkは必須です"); return; }

                btn.disabled = true;
                btn.innerText = "UPLOADING...";

                try {
                    const sb = window.supabase.createClient(CONFIG.url, CONFIG.key);

                    // 1. Profile
                    const { data: prof, error: err1 } = await sb.from('profiles').insert([{
                        dj_name: name,
                        city: getVal('city'),
                        genres: this.selectedGenres,
                        plan: this.currentPlan,
                        is_public: document.getElementById('isPublic') ? document.getElementById('isPublic').checked : false,
                        slug: Math.random().toString(36).slice(-8)
                    }]).select().single();
                    if(err1) throw new Error("Profile Error: " + err1.message);

                    // 2. QR
                    const { data: qr, error: err2 } = await sb.from('qr_codes').insert([{
                        profile_id: prof.id, 
                        qr_type: this.currentPlan,
                        design_type: this.currentDesign,
                        logo_url: LOGO_PATH
                    }]).select().single();
                    if(err2) throw new Error("QR Error: " + err2.message);

                    // 3. Links
                    const saveLink = async (type, url, s, e) => {
                        const payload = { profile_id: prof.id, time_type: type, url: url };
                        if(s && e) { payload.start_time = s.length === 5 ? s+":00" : s; payload.end_time = e.length === 5 ? e+":00" : e; }
                        const { error } = await sb.from('links').insert([payload]);
                        if(error) throw new Error(`Link Error (${type}): ` + error.message);
                    };

                    await saveLink('default', link, null, null);

                    if(this.currentPlan === 'pro') {
                        if(getVal('linkMorning')) await saveLink('morning', getVal('linkMorning'), getVal('timeStartMorning'), getVal('timeEndMorning'));
                        if(getVal('linkDaytime')) await saveLink('daytime', getVal('linkDaytime'), getVal('timeStartDaytime'), getVal('timeEndDaytime'));
                    }
                    if(getVal('linkNight')) await saveLink('nighttime', getVal('linkNight'), getVal('timeStartNight'), getVal('timeEndNight'));

                    const finalUrl = BASE_URL + prof.id; 
                    
                    btn.innerText = "SUCCESS!";
                    alert("登録完了！\nこのQRコードは以下のURLにリンクします:\n" + finalUrl);
                    btn.disabled = false;
                    btn.innerText = "GENERATE QR";

                } catch(e) {
                    console.error(e);
                    alert("エラー: " + e.message);
                    btn.disabled = false;
                    btn.innerText = "RETRY";
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
