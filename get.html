<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GET QR | WHAT U VIBIN TO?</title>
    
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/get.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <a href="index.html" class="logo-link">
                <img src="images/white_logo.png" alt="WHAT U VIBIN TO?" class="header-logo">
            </a>
        </div>
        <button id="menuBtn" class="menu-btn" aria-label="Menu">
            <span></span><span></span><span></span>
        </button>
    </header>

    <div id="menuPanel" class="menu-panel">
        <nav class="menu-nav">
            <a href="index.html" class="nav-link" onclick="closeMenu()">
                <span class="nav-en">Home</span><span class="nav-jp">トップページに戻る</span>
            </a>
            <a href="explore.html" class="nav-link" onclick="closeMenu()">
                <span class="nav-en">Explore</span><span class="nav-jp">あの人の"この時間"をのぞく</span>
            </a>
            <a href="how.html" class="nav-link" onclick="closeMenu()">
                <span class="nav-en">How it works</span><span class="nav-jp">仕組み / 使い方</span>
            </a>
            <a href="getQR.html" class="nav-link highlight" onclick="closeMenu()">
                <span class="nav-en">Get QR</span><span class="nav-jp">あなただけのQRをつくる</span>
            </a>
        </nav>
    </div>

    <main class="form-section">
        <div class="bg-layer">
            <div class="glow-spot-1" style="top: 10%; left: 80%;"></div>
            <div class="glow-spot-2" style="top: 80%; left: 10%;"></div>
        </div>

        <h1 class="form-title">Get Your "Vibin QR"</h1>

        <div class="form-container">
            
            <div class="plan-toggle">
                <button class="plan-btn active" id="btnFree" onclick="setPlan('free')">FREE</button>
                <button class="plan-btn" id="btnPro" onclick="setPlan('pro')">PRO PLAN</button>
            </div>

            <div class="form-group">
                <label class="form-label">DJ Name / Artist Name</label>
                <input type="text" id="djName" class="form-input" placeholder="Ex. DJ YUTO">
            </div>

            <div class="form-group">
                <label class="form-label">City / Location</label>
                <input type="text" id="city" class="form-input" placeholder="Ex. TOKYO">
            </div>

            <div class="form-group">
                <label class="form-label">Genres (Max 3)</label>
                <div class="genre-container" id="genreContainer">
                    <button class="genre-pill" onclick="toggleGenre(this)">House</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">Techno</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">Hip Hop</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">R&B</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">Disco</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">Ambient</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">Bass</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">J-Pop</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">K-Pop</button>
                    <button class="genre-pill" onclick="toggleGenre(this)">Rock</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 32px 0;">

            <div class="form-group">
                <label class="form-label" style="color:#fff;">DEFAULT LINK (REQUIRED)</label>
                <input type="url" id="linkDefault" class="form-input" placeholder="https://spotify.com/playlist/...">
                <p style="font-size:0.7rem; color:#666; margin-top:4px;">※設定時間外にスキャンされた場合に表示されます</p>
            </div>

            <div id="groupMorning" class="time-link-group locked-section">
                <div class="time-header">
                    <span class="time-label">MORNING VIBE</span>
                    <div class="time-inputs">
                        <input type="time" id="timeStartMorning" class="time-input-field" value="06:00">
                        <span>-</span>
                        <input type="time" id="timeEndMorning" class="time-input-field" value="11:00">
                    </div>
                </div>
                <input type="url" id="linkMorning" class="form-input" placeholder="Morning Playlist URL">
            </div>

            <div id="groupDaytime" class="time-link-group locked-section">
                <div class="time-header">
                    <span class="time-label" style="color: #fff;">DAYTIME VIBE</span>
                    <div class="time-inputs">
                        <input type="time" id="timeStartDaytime" class="time-input-field" value="11:00">
                        <span>-</span>
                        <input type="time" id="timeEndDaytime" class="time-input-field" value="18:00">
                    </div>
                </div>
                <input type="url" id="linkDaytime" class="form-input" placeholder="Daytime Playlist URL">
            </div>

            <div id="groupNighttime" class="time-link-group">
                <div class="time-header">
                    <span class="time-label" style="color: #a855f7;">NIGHTTIME VIBE</span>
                    <div class="time-inputs locked-section" id="nightTimeUI"> <input type="time" id="timeStartNight" class="time-input-field" value="18:00">
                        <span>-</span>
                        <input type="time" id="timeEndNight" class="time-input-field" value="06:00">
                    </div>
                </div>
                <input type="url" id="linkNight" class="form-input" placeholder="Night Playlist URL">
            </div>

            <div id="exploreGroup" class="toggle-wrapper locked-section">
                <div>
                    <label class="form-label" style="margin:0; color:#fff;">Show on Explore Page</label>
                    <p style="font-size:0.7rem; color:#666;">Exploreページ（一覧）への掲載</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="isPublic">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="submit-area">
                <button class="btn-primary btn-submit" onclick="generateQR()" id="btnSubmit">
                    <span>GENERATE QR</span>
                </button>
                <p id="msg" style="margin-top:10px; font-size:0.8rem; color:#a855f7; min-height:1.2em;"></p>
            </div>

        </div>
    </main>

    <footer class="site-footer">
        <p class="copyright">© 2026 WHAT U VIBIN TO</p>
    </footer>

    <script>
        // ==========================================
        // 重要：ここにSupabaseのキーを入れてください
        // ==========================================
        const supabaseUrl = 'https://zcjzmuzmhuanyauhgeni.supabase.co'; // ★ Project URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjanptdXptaHVhbnlhdWhnZW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzAyNjAsImV4cCI6MjA4NTQwNjI2MH0.pNB58zLyRR4iM1oYoKeZQcJ1grKyrOY8F-Akd2298-A';     // ★ Anon Public Key
        
        // Supabaseクライアントの初期化
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            } else {
                console.error("Supabase library not loaded!");
            }
        } catch (e) {
            console.error("Supabase init error:", e);
        }

        // ==========================================
        // 1. UI Logic (プラン切り替え & ジャンル選択)
        // ==========================================
        
        // 状態管理
        let currentPlan = 'free';
        let selectedGenres = [];

        // プラン切り替え関数
        window.setPlan = function(plan) {
            console.log("Plan switched to:", plan); // デバッグ用
            currentPlan = plan;
            
            // ボタンの見た目切り替え
            const btnFree = document.getElementById('btnFree');
            const btnPro = document.getElementById('btnPro');
            
            if(plan === 'free') {
                btnFree.classList.add('active');
                btnPro.classList.remove('active');
                toggleLockedSections(true); // ロックする
            } else {
                btnFree.classList.remove('active');
                btnPro.classList.add('active');
                toggleLockedSections(false); // 解除する
            }
        };

        // ロック/解除の制御
        function toggleLockedSections(isLocked) {
            const sections = [
                document.getElementById('groupMorning'),
                document.getElementById('groupDaytime'),
                document.getElementById('nightTimeUI'),
                document.getElementById('exploreGroup')
            ];

            sections.forEach(el => {
                if(el) { // 要素が存在するか確認してから操作
                    if(isLocked) el.classList.add('locked-section');
                    else el.classList.remove('locked-section');
                }
            });

            // Freeの場合は入力値をクリア
            if (isLocked) {
                const linkMorning = document.getElementById('linkMorning');
                const linkDaytime = document.getElementById('linkDaytime');
                const isPublic = document.getElementById('isPublic');
                if(linkMorning) linkMorning.value = '';
                if(linkDaytime) linkDaytime.value = '';
                if(isPublic) isPublic.checked = false;
            } else {
                const isPublic = document.getElementById('isPublic');
                if(isPublic) isPublic.checked = true; // Pro default on
            }
        }

        // ジャンル選択関数
        window.toggleGenre = function(btn) {
            const genre = btn.innerText || btn.textContent; // テキスト取得を確実に
            console.log("Genre clicked:", genre);

            if (selectedGenres.includes(genre)) {
                // 選択解除
                selectedGenres = selectedGenres.filter(g => g !== genre);
                btn.classList.remove('selected');
            } else {
                // 新規選択
                if (selectedGenres.length >= 3) {
                    alert('You can select up to 3 genres.');
                    return;
                }
                selectedGenres.push(genre);
                btn.classList.add('selected');
            }
        };

        // ==========================================
        // 2. Generate QR Logic (DB保存)
        // ==========================================
        window.generateQR = async function() {
            console.log("Generate QR clicked");
            const btn = document.getElementById('btnSubmit');
            const msg = document.getElementById('msg');
            
            // APIキーの入力チェック
            if (supabaseUrl.includes('YOUR_SUPABASE') || supabaseKey.includes('YOUR_ANON')) {
                alert("【設定エラー】\nSupabaseのURLとAPIキーが設定されていません。\nHTMLファイル内の 'YOUR_SUPABASE_URL' を書き換えてください。");
                return;
            }

            // バリデーション
            const nameInput = document.getElementById('djName');
            const defaultLinkInput = document.getElementById('linkDefault');
            
            if (!nameInput.value || !defaultLinkInput.value) {
                alert('Please enter "DJ Name" and "Default Link".');
                return;
            }

            // ボタンをローディング状態に
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>SAVING...</span>';
            msg.textContent = "";

            try {
                // -------------------------
                // 1. プロフィールの保存
                // -------------------------
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .insert([{
                        dj_name: nameInput.value,
                        city: document.getElementById('city').value,
                        genre: selectedGenres, // 配列のまま保存
                        plan: currentPlan,
                        is_public: document.getElementById('isPublic').checked,
                        edit_token: Math.random().toString(36).slice(-8)
                    }])
                    .select()
                    .single();

                if (profileError) throw new Error("Profile Error: " + profileError.message);
                const profileId = profileData.id;

                // -------------------------
                // 2. QRコード設定の保存
                // -------------------------
                const { data: qrData, error: qrError } = await supabase
                    .from('qr_codes')
                    .insert([{
                        profile_id: profileId,
                        qr_type: currentPlan,
                        is_active: true
                    }])
                    .select()
                    .single();

                if (qrError) throw new Error("QR Error: " + qrError.message);
                const qrId = qrData.id;

                // -------------------------
                // 3. リンクの保存 (Default)
                // -------------------------
                await saveLink(profileId, qrId, 'default', defaultLinkInput.value, null, null, true);
                
                // Proプランなら他のリンクも保存
                if (currentPlan === 'pro') {
                    const linkMorning = document.getElementById('linkMorning').value;
                    const linkDaytime = document.getElementById('linkDaytime').value;
                    const linkNight = document.getElementById('linkNight').value;

                    if (linkMorning) await saveLink(profileId, qrId, 'morning', linkMorning, getValue('timeStartMorning'), getValue('timeEndMorning'));
                    if (linkDaytime) await saveLink(profileId, qrId, 'daytime', linkDaytime, getValue('timeStartDaytime'), getValue('timeEndDaytime'));
                    // NightはProでもFreeでも入力されていれば保存する設計の場合
                    if (linkNight) await saveLink(profileId, qrId, 'nighttime', linkNight, getValue('timeStartNight'), getValue('timeEndNight'));
                } else {
                    // Freeの場合でもNighttimeが入力されていれば保存
                    const linkNight = document.getElementById('linkNight').value;
                    if (linkNight) await saveLink(profileId, qrId, 'nighttime', linkNight, getValue('timeStartNight'), getValue('timeEndNight'));
                }

                // 完了処理
                msg.textContent = "SUCCESS! Vibe Created.";
                setTimeout(() => {
                    alert('QR生成完了！\nID: ' + qrId + '\n(DBを確認してください)');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 500);

            } catch (error) {
                console.error(error);
                alert("エラーが発生しました:\n" + error.message);
                msg.textContent = "ERROR: " + error.message;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // リンク保存用ヘルパー関数
        async function saveLink(pId, qId, type, url, start, end, isDefault = false) {
            const payload = {
                profile_id: pId,
                qr_code_id: qId,
                time_type: type,
                url: url,
                is_active: true,
                is_default: isDefault
            };
            
            // 時間データがあれば追加 (HH:MM -> HH:MM:00)
            if (start && end) {
                payload.start_time = start + ":00";
                payload.end_time = end + ":00";
            }

            const { error } = await supabase.from('links').insert([payload]);
            if (error) throw error;
        }

        // inputの値取得用ヘルパー
        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : null;
        }

        // 初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            // Freeプランを初期選択としてUIをロック
            toggleLockedSections(true);
        });

        // メニュー開閉ロジック
        const menuBtn = document.getElementById('menuBtn');
        const menuPanel = document.getElementById('menuPanel');
        let isMenuOpen = false;
        if(menuBtn) {
            menuBtn.addEventListener('click', () => {
                isMenuOpen = !isMenuOpen;
                if (isMenuOpen) {
                    menuPanel.classList.add('menu-open');
                    menuBtn.classList.add('active');
                } else {
                    menuPanel.classList.remove('menu-open');
                    menuBtn.classList.remove('active');
                    isMenuOpen = false;
                }
            });
        }
        window.closeMenu = function() {
            isMenuOpen = false;
            if(menuPanel) menuPanel.classList.remove('menu-open');
            if(menuBtn) menuBtn.classList.remove('active');
        };
    </script>
</body>
</html>
