<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GET QR | DEBUG MODE</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ========== STYLE RESET & BASE ========== */
        :root { --color-neon: #a855f7; --bg: #050505; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; padding-bottom: 200px; }
        
        /* HEADER */
        .site-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: center; }
        .header-logo { height: 30px; }

        /* FORM CONTAINER */
        .form-section { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
        .form-title { font-size: 2rem; margin-bottom: 30px; text-align: center; font-weight: 900; }
        .form-container { width: 100%; max-width: 600px; background: #111; border: 1px solid #333; border-radius: 20px; padding: 30px; }

        /* PLAN SWITCH */
        .plan-toggle { display: flex; background: #222; border-radius: 50px; padding: 4px; margin-bottom: 30px; }
        .plan-btn { flex: 1; padding: 12px; background: none; border: none; color: #888; font-weight: bold; cursor: pointer; border-radius: 50px; transition: 0.3s; }
        .plan-btn.active { background: var(--color-neon); color: #fff; box-shadow: 0 0 15px rgba(168,85,247,0.5); }

        /* INPUTS */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 8px; font-weight: bold; }
        .form-input { width: 100%; padding: 14px; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--color-neon); }

        /* GENRES */
        .genre-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .genre-pill { padding: 8px 16px; border: 1px solid #444; border-radius: 50px; background: transparent; color: #ccc; cursor: pointer; transition: 0.2s; }
        .genre-pill.selected { background: var(--color-neon); border-color: var(--color-neon); color: #fff; font-weight: bold; box-shadow: 0 0 10px rgba(168,85,247,0.5); }

        /* TIME & LOCK */
        .locked-section { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .time-link-group { border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 15px; background: #0a0a0a; }
        .time-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; font-weight: bold; }
        .time-inputs input { background: #000; border: 1px solid #333; color: #fff; padding: 4px; border-radius: 4px; }

        /* EXPLORE SWITCH */
        .toggle-wrapper { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; border-radius: 10px; }
        .switch { position: relative; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-neon); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* SUBMIT BTN */
        .btn-submit { width: 100%; padding: 18px; background: var(--color-neon); color: #fff; font-weight: 900; font-size: 1.1rem; border: none; border-radius: 50px; margin-top: 30px; cursor: pointer; box-shadow: 0 0 20px rgba(168,85,247,0.4); }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        /* DEBUG CONSOLE (画面右下のログ表示エリア) */
        #debugConsole {
            position: fixed; bottom: 0; right: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.9); border-top: 2px solid #333;
            color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; overflow-y: scroll; z-index: 9999;
        }
    </style>
</head>
<body>

    <header class="site-header">
        <span>WHAT U VIBIN TO? (FORM TEST)</span>
    </header>

    <main class="form-section">
        <h1 class="form-title">GET YOUR QR</h1>
        <div class="form-container">

            <div class="plan-toggle">
                <button type="button" class="plan-btn active" id="btnFree" onclick="app.setPlan('free')">FREE</button>
                <button type="button" class="plan-btn" id="btnPro" onclick="app.setPlan('pro')">PRO PLAN</button>
            </div>

            <div class="form-group">
                <label class="form-label">DJ NAME</label>
                <input type="text" id="djName" class="form-input" placeholder="Enter Name">
            </div>

            <div class="form-group">
                <label class="form-label">GENRES (Select up to 3)</label>
                <div class="genre-container">
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">House</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Techno</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Hip Hop</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">R&B</button>
                    <button type="button" class="genre-pill" onclick="app.toggleGenre(this)">Disco</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 30px 0;">

            <div class="form-group">
                <label class="form-label" style="color:#fff">DEFAULT LINK (Required)</label>
                <input type="url" id="linkDefault" class="form-input" placeholder="Spotify URL">
            </div>

            <div id="groupMorning" class="time-link-group locked-section">
                <div class="time-header"><span>MORNING (06:00-11:00)</span></div>
                <input type="url" id="linkMorning" class="form-input" placeholder="Morning URL">
                <input type="hidden" id="timeStartMorning" value="06:00">
                <input type="hidden" id="timeEndMorning" value="11:00">
            </div>

            <div id="groupDaytime" class="time-link-group locked-section">
                <div class="time-header"><span>DAYTIME (11:00-18:00)</span></div>
                <input type="url" id="linkDaytime" class="form-input" placeholder="Daytime URL">
                <input type="hidden" id="timeStartDaytime" value="11:00">
                <input type="hidden" id="timeEndDaytime" value="18:00">
            </div>

            <div id="groupNight" class="time-link-group">
                <div class="time-header"><span style="color:var(--color-neon)">NIGHT (18:00-06:00)</span></div>
                <input type="url" id="linkNight" class="form-input" placeholder="Night URL">
                <div id="nightTimeUI" class="locked-section" style="margin-top:10px;">
                    <input type="time" id="timeStartNight" value="18:00"> - <input type="time" id="timeEndNight" value="06:00">
                </div>
            </div>

            <div id="exploreGroup" class="toggle-wrapper locked-section">
                <span class="form-label" style="margin:0">SHOW ON EXPLORE</span>
                <label class="switch">
                    <input type="checkbox" id="isPublic">
                    <span class="slider"></span>
                </label>
            </div>

            <button type="button" class="btn-submit" id="btnSubmit" onclick="app.generateQR()">GENERATE QR</button>
            
        </div>
    </main>
    
    <div id="debugConsole">DEBUG LOG START...<br></div>

    <script>
        // ===============================================
        // 設定: ここにSupabaseのキーを入れてください
        // ===============================================
        const CONFIG = {
            url: 'https://zcjzmuzmhuanyauhgeni.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjanptdXptaHVhbnlhdWhnZW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzAyNjAsImV4cCI6MjA4NTQwNjI2MH0.pNB58zLyRR4iM1oYoKeZQcJ1grKyrOY8F-Akd2298-A'
        };

        // ===============================================
        // ログ機能
        // ===============================================
        function log(msg) {
            const consoleBox = document.getElementById('debugConsole');
            if(consoleBox) {
                const time = new Date().toLocaleTimeString();
                consoleBox.innerHTML += `[${time}] ${msg}<br>`;
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
            console.log(msg);
        }

        // ===============================================
        // アプリケーション
        // ===============================================
        const app = {
            currentPlan: 'free',
            selectedGenres: [],

            init: function() {
                log("App Initialized.");
                this.setPlan('free');
            },

            setPlan: function(plan) {
                log("Switching Plan to: " + plan);
                this.currentPlan = plan;
                document.getElementById('btnFree').className = plan === 'free' ? 'plan-btn active' : 'plan-btn';
                document.getElementById('btnPro').className = plan === 'pro' ? 'plan-btn active' : 'plan-btn';
                
                const lockList = ['groupMorning', 'groupDaytime', 'nightTimeUI', 'exploreGroup'];
                lockList.forEach(id => {
                    const el = document.getElementById(id);
                    if(plan === 'free') el.classList.add('locked-section');
                    else el.classList.remove('locked-section');
                });
                document.getElementById('isPublic').checked = (plan === 'pro');
            },

            toggleGenre: function(btn) {
                const val = btn.innerText;
                if(this.selectedGenres.includes(val)) {
                    this.selectedGenres = this.selectedGenres.filter(g => g !== val);
                    btn.classList.remove('selected');
                } else {
                    if(this.selectedGenres.length >= 3) { alert("Max 3 genres"); return; }
                    this.selectedGenres.push(val);
                    btn.classList.add('selected');
                }
            },

            generateQR: async function() {
                log("Generate Button Clicked.");
                const btn = document.getElementById('btnSubmit');

                if(CONFIG.url.includes('YOUR_')) {
                    alert("APIキーが設定されていません。"); return;
                }

                const name = document.getElementById('djName').value;
                const link = document.getElementById('linkDefault').value;
                if(!name || !link) { alert("名前とDefault Linkは必須です"); return; }

                btn.disabled = true;
                btn.innerText = "CONNECTING...";

                try {
                    const sb = window.supabase.createClient(CONFIG.url, CONFIG.key);

                    // 1. Profile保存
                    log("Saving Profile...");
                    const { data: prof, error: err1 } = await sb.from('profiles').insert([{
                        dj_name: name,
                        city: document.getElementById('city').value,
                        // ★修正1: 列名を 'genres' (複数形) に修正
                        genres: this.selectedGenres, 
                        plan: this.currentPlan,
                        is_public: document.getElementById('isPublic').checked,
                        slug: Math.random().toString(36).slice(-8)
                    }]).select().single();
                    
                    if(err1) throw new Error("Profile Error: " + err1.message);
                    log("Profile Saved ID: " + prof.id);

                    // 2. QR保存
                    log("Saving QR Code...");
                    const { data: qr, error: err2 } = await sb.from('qr_codes').insert([{
                        profile_id: prof.id, 
                        qr_type: this.currentPlan
                    }]).select().single();
                    
                    if(err2) throw new Error("QR Error: " + err2.message);
                    log("QR Saved ID: " + qr.id);

                    // 3. Links保存 (ここを修正)
                    log("Saving Links...");
                    
                    // ヘルパー関数を修正
                    const saveLink = async (type, url, s, e) => {
                        // ★修正2: 存在しない列 (qr_code_id, is_default) を削除
                        const payload = { 
                            profile_id: prof.id,
                            time_type: type, 
                            url: url
                        };
                        // 時間がある場合のみ追加
                        if(s && e) { 
                            payload.start_time = s + ":00"; 
                            payload.end_time = e + ":00"; 
                        }

                        const { error } = await sb.from('links').insert([payload]);
                        // ★修正3: エラーがあったら無視せず投げる
                        if(error) throw new Error(`Link Error (${type}): ` + error.message);
                    };

                    // Default Link
                    await saveLink('default', link, null, null);
                    log("Default Link OK");

                    // Other Links
                    const getVal = (id) => document.getElementById(id).value;
                    
                    if(this.currentPlan === 'pro') {
                        if(getVal('linkMorning')) await saveLink('morning', getVal('linkMorning'), getVal('timeStartMorning'), getVal('timeEndMorning'));
                        if(getVal('linkDaytime')) await saveLink('daytime', getVal('linkDaytime'), getVal('timeStartDaytime'), getVal('timeEndDaytime'));
                    }
                    if(getVal('linkNight')) await saveLink('nighttime', getVal('linkNight'), getVal('timeStartNight'), getVal('timeEndNight'));

                    btn.innerText = "SUCCESS!";
                    alert("成功！今度こそ全てのデータが保存されました。");
                    btn.disabled = false;

                } catch(e) {
                    console.error(e);
                    log("ERROR: " + e.message);
                    alert("エラー発生: " + e.message);
                    btn.disabled = false;
                    btn.innerText = "RETRY";
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
