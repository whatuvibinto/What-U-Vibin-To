<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
</head>
<body>

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// I WANNA GO TO AMSTERDAM /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// I WANNA GO TO AMSTERDAM /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper">
        <a href="#" onclick="closeAboutPanel(); return false;">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="main-content">
        <nav class="nav-links">
            <a href="#" onclick="openAboutPanel(); return false;">About</a>
            <a href="books.html">Books</a>
            <a href="contact.html">Contact</a>
            <a href="dig.html" class="special-link">Dig for new music</a>
            <a href="event.html">Events</a>
        </nav>

        <div class="record-wrapper" id="recordArea">
            <img src="images/record_v2.svg" alt="Vinyl Record" class="record-img" id="recordDisk">
        </div>
    </div>

    <div class="footer">
        Developed by Lucy, Wassup bro
    </div>
</div>

<div class="about-bottom-panel panel-animate" id="swipePanel">
    <div class="panel-header" id="panelHeader">
        <div class="swipe-indicator"></div>
    </div>
    <div class="about-scroll-container" id="panelContent">
        <div class="about-content-inner">
            <h2 class="about-main-title">ABOUT</h2>
            <p class="about-intro">
                このサイトは、気になるあの人のミュージックプレイリストを紹介します。<br>
                ぜひ、新しい音楽との出会いを楽しんでください。
            </p>
            <p class="about-note">
                ※「What u vibin to?」とは、「最近何にノってんの？」「最近どんな曲聴いてんの？」というニュアンスの口語です
            </p>
            <div class="about-columns">
                <dl>
                    <dt><a href="books.html">Books</a></dt>
                    <dd>オリジナルアートブックのアーカイブを見ることができます。<br>
                    <span class="small-note">※軍資金がそろい次第始動します。</span></dd>
                </dl>
                <dl>
                    <dt><a href="contact.html">Contact</a></dt>
                    <dd>本サイトでの掲載依頼などのお問い合わせはこちらから</dd>
                </dl>
                <dl>
                    <dt class="highlight-text"><a href="dig.html">Dig for new music</a></dt>
                    <dd>気になるあの人のミュージックプレイリストへQRコードへ飛びます。<br>
                    本サイトのメインにあたるディグページです。</dd>
                </dl>
                <dl>
                    <dt><a href="event.html">Events</a></dt>
                    <dd>イベント情報を掲載しています。さあ、夜の街へ繰り出そう</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<audio id="scratchAudio" src="images/scratch.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {

    /* =================================================================
       機能1: Aboutパネルの制御
       ================================================================= */
    const panel = document.getElementById('swipePanel');
    const panelHeader = document.getElementById('panelHeader');
    const panelContent = document.getElementById('panelContent');
    const navLinks = document.querySelector('.nav-links');
    
    // パネルの状態管理
    let isPanelOpen = false;
    let isPanelDragging = false;
    let panelStartY = 0;
    let panelCurrentY = 0;

    // --- 公開関数 (HTMLのonclickから呼ぶ) ---
    window.openAboutPanel = function() {
        if(!panel) return;
        panel.style.transform = 'translateY(0)';
        isPanelOpen = true;
        if(navLinks) navLinks.style.opacity = '0.3'; // ナビを目立たなくする
    };

    window.closeAboutPanel = function() {
        if(!panel) return;
        panel.style.transform = 'translateY(100%)';
        isPanelOpen = false;
        if(navLinks) navLinks.style.opacity = '1';
        // 閉じた後にスクロール位置をリセット
        setTimeout(() => { if(panelContent) panelContent.scrollTop = 0; }, 300);
    };

    // --- パネルのタッチ操作 ---
    if(panel) {
        // タッチ開始
        panel.addEventListener('touchstart', (e) => {
            const touchY = e.touches[0].clientY;
            const scrollTop = panelContent.scrollTop;
            // ヘッダー部分を触ったか判定
            const isHeader = panelHeader.contains(e.target);
            
            // 「中身」のスクロール中はパネル自体を動かさない
            // (ヘッダーを掴んでいる時、またはスクロール位置がトップの時だけ動かす)
            if (!isHeader && scrollTop > 0) {
                isPanelDragging = false;
                return;
            }
            isPanelDragging = true;
            panelStartY = touchY;
            panel.classList.remove('panel-animate'); // ドラッグ中はアニメーションをオフ
        }, { passive: false });

        // タッチ移動
        panel.addEventListener('touchmove', (e) => {
            if (!isPanelDragging) return;
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - panelStartY; 
            
            let newY = deltaY;
            if (deltaY < 0) newY = deltaY * 0.3; // 上に引っ張る時は抵抗をつける
            
            // 下方向へのスワイプ（閉じる動作）の時は、ブラウザ標準のスクロール等を防ぐ
            if (deltaY > 0 && e.cancelable) e.preventDefault();

            panel.style.transform = `translateY(${newY}px)`;
            panelCurrentY = newY;
        }, { passive: false });

        // タッチ終了
        panel.addEventListener('touchend', () => {
            if (!isPanelDragging) return;
            isPanelDragging = false;
            panel.classList.add('panel-animate'); // アニメーションをオンに戻す

            // 150px以上下に引っ張ったら閉じる
            if (panelCurrentY > 150) {
                closeAboutPanel();
            } else {
                // 元の位置に戻る
                panel.style.transform = `translateY(0px)`;
                panelCurrentY = 0;
            }
        });

        // パネル外（背景）をクリックしたら閉じる
        document.addEventListener('click', (e) => {
            if (isPanelOpen && panel) {
                // パネル自体、または「開くボタン」以外をクリックした場合
                if (!panel.contains(e.target) && !e.target.closest('a[onclick*="openAboutPanel"]')) {
                    closeAboutPanel();
                }
            }
        });
    }


    /* =================================================================
       機能2: レコードのスクラッチ (Web Audio API)
       ================================================================= */
    const recordArea = document.getElementById('recordArea');
    const recordDisk = document.getElementById('recordDisk');
    
    // パラメータ
    const AUDIO_URL = 'images/scratch.mp3'; 
    const FRICTION = 0.92;   // 摩擦（慣性）
    const SENSITIVITY = 1.2; // 感度

    // Web Audio変数
    let audioCtx = null;
    let audioBuffer = null;
    let sourceNode = null;
    let gainNode = null;
    let isAudioUnlocked = false;

    // レコード物理演算変数
    let isRecordDragging = false;
    let recordVelocity = 0;
    let recordCurrentRotation = 0;
    let recordLastMouseAngle = 0;
    
    // 音声ファイルのロード
    async function loadAudio() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            const response = await fetch(AUDIO_URL);
            const arrayBuffer = await response.arrayBuffer();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.error("Audio Load Error:", error);
        }
    }
    loadAudio();

    // スマホ用ロック解除 (ユーザー操作の初回に実行
