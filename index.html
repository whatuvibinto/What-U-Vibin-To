<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
    <style>
        /* =========================================
           New Navigation Styles for Subtitles
           ========================================= */
        .nav-links a {
            display: flex;
            flex-direction: column; /* Stack English and Japanese vertically */
            align-items: flex-start; /* Align to the left */
            line-height: 1.2; /* Tighter line height for the group */
            margin-bottom: 15px; /* Add some space between items */
        }

        .nav-subtitle {
            display: block;
            font-size: 0.65rem; /* Smaller font size */
            font-weight: normal; /* Non-bold */
            color: #888; /* Gray color (faint) */
            margin-top: 2px; /* Slight gap from the English text */
            letter-spacing: 0.05em; /* Normal spacing */
            text-transform: none; /* Keep Japanese as is */
            opacity: 0.8;
            font-family: "Helvetica Neue", Helvetica, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Arial, sans-serif;
        }

        /* Adjust hover effect to move the whole block */
        @media (min-width: 769px) {
            .nav-links a:hover {
                transform: translateX(10px);
            }
            /* Ensure the color change applies to the main text, keep subtitle gray or slightly darker */
            .nav-links a:hover .nav-subtitle {
                color: #666;
            }
        }
    </style>
</head>
<body>

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// KEEP DIGGING ///WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// KEEP DIGGING ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper">
        <a href="#" onclick="closeAboutPanel(); return false;">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="main-content">
        <nav class="nav-links" id="navLinks"> 
            <a href="dig.html" id="exploreLink"class="special-link">
                EXPLORE
                <span class="nav-subtitle">あの人が今聞いている曲をのぞく</span>
            </a>

            <a href="#" onclick="openAboutPanel(); return false;">
                HOW IT WORKS
                <span class="nav-subtitle">このQRの仕組み、使い方</span>
            </a>

            <a href="contact.html" id="getQrLink">
                GET YOURS
                <span class="nav-subtitle">あなただけの音の名刺を作る</span>
            </a>
        </nav>

        <div class="record-wrapper" id="recordArea">
            <img src="images/record_v2.svg" alt="Vinyl Record" class="record-img" id="recordDisk">
        </div>

        <div class="tonearm-wrapper" id="tonearm">
            <img src="images/tonearm.svg" alt="Tonearm" class="tonearm-img">
            <span class="tonearm-tap-hint"></span>
        </div>
    </div>

    <div class="footer">
        KEEP DIGGING, KEEP VIBING
    </div>
</div>

<div class="about-bottom-panel panel-animate" id="swipePanel">
    <div class="panel-header" id="panelHeader">
        <div class="swipe-indicator"></div>
    </div>
    <div class="about-scroll-container" id="panelContent">
        <div class="about-content-inner">
            <div class="about-panel-logo">
                <img src="images/logo.svg" alt="Logo">
            </div>
            
            <h2 class="about-main-title">HOW IT WORKS</h2>
            <p class="about-intro">
                「What u vibin to?」へようこそ。<br>
                ここは、音のセンスで繋がる新しい社交場です。<br>
                <span class="small-note">Welcome to "What u vibin to?". <br>A new social space connected by musical taste.</span>
            </p>

            <div class="about-columns">
                <dl>
                    <dt class="highlight-text">STEP 1: EXPLORE</dt>
                    <dd>
                        気になるあの人のQRコードをスキャン。<br>
                        その人が「今」聴いているプレイリストにアクセスできます。<br>
                        <span class="small-note">Scan the QR code of someone who catches your eye. Access their "current" playlist instantly.</span>
                    </dd>
                </dl>
                <dl>
                    <dt>STEP 2: VIBE</dt>
                    <dd>
                        流れてくる音楽に耳を傾けて。<br>
                        新しいお気に入りの曲が見つかるかもしれません。<br>
                        <span class="small-note">Listen to the vibes. You might just find your next favorite song.</span>
                    </dd>
                </dl>
                <dl>
                    <dt>STEP 3: GET YOURS</dt>
                    <dd>
                        あなたも自分の「音の名刺」を作りませんか？<br>
                        時間帯によって変わるプレイリストで、あなたのセンスを表現しましょう。<br>
                        <span class="small-note">Create your own "Audio Business Card". Express your taste with playlists that change with the time of day.</span>
                    </dd>
                </dl>
            </div>
            
            <p class="logo-note" style="margin-top: 40px;">
                <a href="contact.html" style="text-decoration: underline; color: #333; font-weight: bold;">
                    GET YOUR QR CODE HERE &rarr;
                </a>
            </p>
        </div>
    </div>
</div>

<audio id="scratchAudio" src="images/scratch.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {

    /* =================================================================
       Function 1: Panel Control (About / How it works)
       ================================================================= */
    const panel = document.getElementById('swipePanel');
    const panelHeader = document.getElementById('panelHeader');
    const panelContent = document.getElementById('panelContent');
    const navLinks = document.querySelector('.nav-links');
    
    let isPanelOpen = false;
    let isPanelDragging = false;
    let panelStartY = 0;
    let panelCurrentY = 0;

    window.openAboutPanel = function() {
        if(!panel) return;
        panel.style.transform = 'translateY(0)';
        isPanelOpen = true;
        if(navLinks) navLinks.style.opacity = '0.3';
    };

    window.closeAboutPanel = function() {
        if(!panel) return;
        panel.style.transform = 'translateY(100%)';
        isPanelOpen = false;
        if(navLinks) navLinks.style.opacity = '1';
        setTimeout(() => { if(panelContent) panelContent.scrollTop = 0; }, 300);
    };

    if(panel) {
        panel.addEventListener('touchstart', (e) => {
            const touchY = e.touches[0].clientY;
            const scrollTop = panelContent.scrollTop;
            const isHeader = panelHeader.contains(e.target);
            if (!isHeader && scrollTop > 0) {
                isPanelDragging = false;
                return;
            }
            isPanelDragging = true;
            panelStartY = touchY;
            panel.classList.remove('panel-animate');
        }, { passive: false });

        panel.addEventListener('touchmove', (e) => {
            if (!isPanelDragging) return;
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - panelStartY; 
            let newY = deltaY;
            if (deltaY < 0) newY = deltaY * 0.3;
            if (deltaY > 0 && e.cancelable) e.preventDefault();
            panel.style.transform = `translateY(${newY}px)`;
            panelCurrentY = newY;
        }, { passive: false });

        panel.addEventListener('touchend', () => {
            if (!isPanelDragging) return;
            isPanelDragging = false;
            panel.classList.add('panel-animate');
            if (panelCurrentY > 150) {
                closeAboutPanel();
            } else {
                panel.style.transform = `translateY(0px)`;
                panelCurrentY = 0;
            }
        });

        document.addEventListener('click', (e) => {
            if (isPanelOpen && panel) {
                if (!panel.contains(e.target) && !e.target.closest('a[onclick*="openAboutPanel"]')) {
                    closeAboutPanel();
                }
            }
        });
    }

    /* =================================================================
       Function 2: Page Transitions
       ================================================================= */
    const exploreLink = document.getElementById('exploreLink');
    const getQrLink = document.getElementById('getQrLink');
    const navLinksContainer = document.getElementById('navLinks');
    const recordWrapper = document.getElementById('recordArea');
    const tonearmWrapper = document.getElementById('tonearm'); 

    // Common transition handler
    function handlePageTransition(e) {
        e.preventDefault(); 
        const targetUrl = e.currentTarget.href; 
        
        if(recordWrapper) recordWrapper.classList.add('slide-out-left');
        if(navLinksContainer) navLinksContainer.classList.add('slide-out-right');
        if(tonearmWrapper) tonearmWrapper.classList.add('slide-out-bottom');

        setTimeout(() => {
            window.location.href = targetUrl;
        }, 800);
    }

    if (exploreLink) exploreLink.addEventListener('click', handlePageTransition);
    if (getQrLink) getQrLink.addEventListener('click', handlePageTransition);

    window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
            if(recordWrapper) recordWrapper.classList.remove('slide-out-left');
            if(navLinksContainer) navLinksContainer.classList.remove('slide-out-right');
            if(tonearmWrapper) tonearmWrapper.classList.remove('slide-out-bottom');
        }
    });

    /* =================================================================
       Function 3: Record Player (Scratch & Tonearm)
       ================================================================= */
    const recordArea = document.getElementById('recordArea');
    const recordDisk = document.getElementById('recordDisk');
    
    const AUDIO_URL = 'images/scratch.mp3'; 
    const FRICTION = 0.92;
    const SENSITIVITY = 1.2;

    let audioCtx = null;
    let audioBuffer = null;
    let sourceNode = null;
    let gainNode = null;
    
    let isNeedleDropped = false; 
    let isRecordDragging = false;
    let recordVelocity = 0;
    let recordCurrentRotation = 0;
    let recordLastMouseAngle = 0;

    async function loadAudio() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            const response = await fetch(AUDIO_URL);
            const arrayBuffer = await response.arrayBuffer();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.error("Audio Load Error:", error);
        }
    }
    loadAudio();

    function unlockAudio() {
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }
    document.body.addEventListener('touchstart', unlockAudio, { once: true });
    document.body.addEventListener('click', unlockAudio, { once: true });

    if (tonearmWrapper) {
        tonearmWrapper.addEventListener('click', (e) => {
            e.stopPropagation(); 
            unlockAudio(); 
            
            isNeedleDropped = !isNeedleDropped;
            
            if (isNeedleDropped) {
                tonearmWrapper.classList.add('tonearm-active');
            } else {
                tonearmWrapper.classList.remove('tonearm-active');
                stopSound(); 
            }
        });
    }

    function updateSound(currentVel) {
        if (!isNeedleDropped) {
            stopSound();
            return;
        }
        if (!audioCtx || !audioBuffer) return;

        if (!sourceNode && Math.abs(currentVel) > 0.1) {
            sourceNode = audioCtx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.loop = true;
            gainNode = audioCtx.createGain();
            sourceNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            sourceNode.start(0);
        }

        if (sourceNode && gainNode) {
            let speed = Math.abs(currentVel) * SENSITIVITY;
            if (speed > 3.0) speed = 3.0; 
            if (speed < 0.05) speed = 0;

            const now = audioCtx.currentTime;
            sourceNode.playbackRate.setTargetAtTime(speed, now, 0.02);
            const volume = Math.min(speed, 1.0);
            gainNode.gain.setTargetAtTime(volume, now, 0.02);
        }
    }

    function stopSound() {
        if (sourceNode) {
            const node = sourceNode;
            const gain = gainNode;
            sourceNode = null; 
            gainNode = null;
            if (gain && audioCtx) {
                gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
                setTimeout(() => { try { node.stop(); } catch(e){} }, 150);
            }
        }
    }

    function animateRecord() {
        if (!isRecordDragging) {
            recordVelocity *= FRICTION; 
        }
        if (Math.abs(recordVelocity) < 0.001) {
            recordVelocity = 0;
            stopSound();
        } else {
            recordCurrentRotation += recordVelocity;
            if(recordDisk) recordDisk.style.transform = `rotate(${recordCurrentRotation}deg)`;
            updateSound(recordVelocity);
        }
        requestAnimationFrame(animateRecord);
    }
    animateRecord();

    function getCenter(el) {
        const rect = el.getBoundingClientRect();
        return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
    }
    function getAngle(x, y, center) {
        const dy = y - center.y;
        const dx = x - center.x;
        return Math.atan2(dy, dx) * (180 / Math.PI);
    }

    if(recordArea) {
        function startRecordDrag(x, y) {
            if (isPanelOpen) return;
            unlockAudio();
            isRecordDragging = true;
            const center = getCenter(recordArea);
            recordLastMouseAngle = getAngle(x, y, center);
            recordArea.style.cursor = 'grabbing';
        }

        function moveRecordDrag(x, y) {
            if (!isRecordDragging) return;
            const center = getCenter(recordArea);
            const angle = getAngle(x, y, center);
            let delta = angle - recordLastMouseAngle;
            while (delta <= -180) delta += 360;
            while (delta > 180) delta -= 360;
            recordVelocity = delta;
            recordLastMouseAngle = angle;
        }

        function endRecordDrag() {
            isRecordDragging = false;
            recordArea.style.cursor = 'grab';
        }

        /* 修正後（中括弧 { } で囲って、e.preventDefault() を追加） */
        recordArea.addEventListener('mousedown', e => {
            e.preventDefault(); // ★ここを追加：PCでの不要なドラッグ動作・選択動作をブロック
            startRecordDrag(e.clientX, e.clientY);
        });
        window.addEventListener('mousemove', e => {
    // レコードをドラッグしている時だけ、画面の動きを止める
            if (isRecordDragging) {
                e.preventDefault(); /* ★ここを追加！ これでぐらぐらが止まります */
                moveRecordDrag(e.clientX, e.clientY);
            }
        });
        window.addEventListener('mouseup', endRecordDrag);

        recordArea.addEventListener('touchstart', e => {
            if (isPanelOpen) return; 
            startRecordDrag(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

        window.addEventListener('touchmove', e => {
            if (isRecordDragging) {
                e.preventDefault(); 
                moveRecordDrag(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        window.addEventListener('touchend', endRecordDrag);
    }
});
</script>

</body>
</html>
