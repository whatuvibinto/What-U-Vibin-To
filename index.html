<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
</head>
<body>

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// I WANNA GO TO AMSTERDAM /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// TOKYO /// STRICTLY VINYL ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper">
        <a href="index.html">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="main-content">
        <nav class="nav-links">
            <a href="about.html">About</a>
            <a href="books.html">Books</a>
            <a href="contact.html">Contact</a>
            <a href="dig.html" class="special-link">Dig for new music</a>
            <a href="event.html">Events</a>
        </nav>

        <div class="record-wrapper" id="recordArea">
            <img src="images/record.svg" alt="Vinyl Record" class="record-img" id="recordDisk">
        </div>
    </div>

    <div class="footer">
        Developed by Lucy, Wassup bro
    </div>
</div>

<audio id="scratchAudio" src="images/scratch.mp3" preload="auto"></audio>
<script>
    /* --- プロ仕様 リアルスクラッチ機能 (Web Audio API + 慣性物理演算) --- */

    const recordArea = document.getElementById('recordArea');
    const recordDisk = document.getElementById('recordDisk');

    // 設定
    const AUDIO_URL = 'scratch.mp3'; // アップロードされたファイル名
    const SENSITIVITY = 0.015;       // 感度（数値を変えて好みの重さに調整可）
    const FRICTION = 0.90;           // 摩擦係数（手を離した後の止まりやすさ 0.8~0.95）

    // --- Web Audio API 変数 ---
    let audioCtx;
    let audioBuffer;
    let sourceNode;
    let gainNode;
    let isAudioLoaded = false;
    let isPlaying = false;

    // --- 物理演算用 変数 ---
    let isDragging = false;
    let startAngle = 0;
    let currentRotation = 0;
    let velocity = 0;           // 現在の回転速度
    let lastMouseAngle = 0;
    let lastTime = 0;
    let rafId = null;           // アニメーションフレームID

    // 1. 音声ファイルをロードしてデコードする
    async function loadAudio() {
        try {
            const response = await fetch(AUDIO_URL);
            const arrayBuffer = await response.arrayBuffer();
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            isAudioLoaded = true;
            console.log("Audio Loaded!");
        } catch (error) {
            console.error("Audio Load Error:", error);
        }
    }
    loadAudio(); // ページ読み込み時にロード開始

    // 2. 音を鳴らす準備（ソースノード作成）
    function createSource() {
        if (!audioCtx || !audioBuffer) return null;
        
        const src = audioCtx.createBufferSource();
        src.buffer = audioBuffer;
        
        // ★重要: 短い音でも途切れないようにループさせる
        src.loop = true; 

        // ゲイン（音量）ノード
        const gain = audioCtx.createGain();
        src.connect(gain);
        gain.connect(audioCtx.destination);

        return { src, gain };
    }

    // 3. アニメーションループ（常に回り続ける監視役）
    function animate() {
        // ドラッグしていない時は、摩擦で徐々に減速させる（慣性）
        if (!isDragging) {
            velocity *= FRICTION;
        }

        // 速度がほぼ0なら止める（無駄な計算を防ぐ）
        if (Math.abs(velocity) < 0.001) {
            velocity = 0;
            if (isPlaying && !isDragging) {
                stopSound(); // 完全に止まったら音も止める
            }
        } else {
            // 速度がある場合
            currentRotation += velocity;
            recordDisk.style.transform = `rotate(${currentRotation}deg)`;
            
            // 音の更新
            updateSound(velocity);
        }

        rafId = requestAnimationFrame(animate);
    }

    // 4. 音の再生・速度変更ロジック
    function updateSound(currentVelocity) {
        // 音が鳴っていないなら鳴らす
        if (!isPlaying && Math.abs(currentVelocity) > 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const nodes = createSource();
            if (nodes) {
                sourceNode = nodes.src;
                gainNode = nodes.gain;
                sourceNode.start(0);
                isPlaying = true;
            }
        }

        if (sourceNode && gainNode) {
            // 速度に応じて再生速度(ピッチ)を変える
            // Math.absで絶対値にする（逆回転でも音を鳴らすため）
            // ※よりリアルにするには絶対値(pitch)だけでなく再生方向制御が必要だが、
            //   Web Audioでの逆再生は複雑なため、ピッチ変化で擬似的に表現します。
            let rate = Math.abs(currentVelocity) * 1.5; 
            
            // あまりに遅いとノイズになるので制限
            if (rate < 0.05) rate = 0;
            if (rate > 4.0) rate = 4.0; // 上限

            // パラメータを滑らかに変化させる
            sourceNode.playbackRate.setTargetAtTime(rate, audioCtx.currentTime, 0.01);
            
            // 止まりかけは音量を絞る
            const volume = Math.min(Math.abs(currentVelocity) / 5, 1);
            gainNode.gain.setTargetAtTime(volume, audioCtx.currentTime, 0.01);
        }
    }

    function stopSound() {
        if (sourceNode) {
            try { sourceNode.stop(); } catch(e){}
            sourceNode = null;
        }
        isPlaying = false;
    }

    // --- 座標計算ヘルパー ---
    function getCenter(element) {
        const rect = element.getBoundingClientRect();
        return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
    }

    function getAngle(x, y, center) {
        const dy = y - center.y;
        const dx = x - center.x;
        return Math.atan2(dy, dx) * (180 / Math.PI);
    }

    // --- マウス/タッチ イベント ---
    
    function startInteraction(x, y) {
        isDragging = true;
        const center = getCenter(recordArea);
        lastMouseAngle = getAngle(x, y, center);
        lastTime = Date.now();
        
        // ブラウザの自動再生制限解除のため
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function moveInteraction(x, y) {
        if (!isDragging) return;

        const center = getCenter(recordArea);
        const angle = getAngle(x, y, center);
        
        // 角度の差分を計算（-180 ~ 180度の範囲に補正）
        let delta = angle - lastMouseAngle;
        while (delta <= -180) delta += 360;
        while (delta > 180) delta -= 360;

        // 速度に反映（直接回転させるのではなく、velocityを与える）
        velocity = delta;

        lastMouseAngle = angle;
    }

    function endInteraction() {
        isDragging = false;
        // 手を離しても animate() 内で friction により徐々に止まる
    }

    // イベント登録
    recordArea.addEventListener('mousedown', e => startInteraction(e.clientX, e.clientY));
    window.addEventListener('mousemove', e => moveInteraction(e.clientX, e.clientY));
    window.addEventListener('mouseup', endInteraction);

    recordArea.addEventListener('touchstart', e => {
        startInteraction(e.touches[0].clientX, e.touches[0].clientY);
    }, {passive: false});
    window.addEventListener('touchmove', e => {
        e.preventDefault(); // スクロール防止
        moveInteraction(e.touches[0].clientX, e.touches[0].clientY);
    }, {passive: false});
    window.addEventListener('touchend', endInteraction);

    // アニメーション開始
    animate();

</script>

</body>
</html>
