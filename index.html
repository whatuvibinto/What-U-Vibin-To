<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <a href="#" onclick="closeExplore(); return false;">
                <img src="images/3D_newLogo.svg" alt="WHAT U VIBIN TO?" class="header-logo">
            </a>
        </div>
        <button class="menu-btn" id="menuBtn" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <div class="menu-panel" id="menuPanel">
        <nav class="menu-nav">
            <a href="#" onclick="openExplore(); toggleMenu(); return false;" class="menu-link">
                <span class="en-text">Explore</span>
                <span class="jp-sub">あの人が"この時間"に聞いている曲をのぞく</span>
            </a>
            <a href="how.html" class="menu-link">
                <span class="en-text">How it works</span>
                <span class="jp-sub">このQRの仕組み/使い方</span>
            </a>
            <a href="getQR.html" class="menu-link highlight">
                <span class="en-text">Get Your QR</span>
                <span class="jp-sub">あなただけのQRをつくる</span>
            </a>
        </nav>
    </div>

    <main class="hero-section" id="heroSection">
        <div class="container">
            <div class="hero-text">
                <h1 class="main-copy">
                    自己紹介は、<br>
                    音楽でもアリ。
                </h1>
                <p class="sub-copy-jp">
                    あなたの"時間帯で変わるバイブス"を、<br>QRひとつで。
                </p>
                <div class="sub-copy-en">
                    <p>Your intro can be music.</p>
                    <p>One QR, different vibes.</p>
                </div>

                <div class="hero-actions">
                    <a href="getQR.html" class="btn btn-primary">Get your QR</a>
                    <div class="action-group">
                        <a href="how.html" class="btn btn-secondary">How it works <span class="arrow">&gt;</span></a>
                        <span class="btn-sub-text">このQRの仕組み/使い方</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="hero-background">
            <img src="images/background_3.svg" alt="" class="bg-graphic">
        </div>

        <div class="swipe-indicator-area" onclick="openExplore()">
            <div class="swipe-arrow"></div>
            <div class="swipe-text">
                <span class="en">Swipe up to Explore</span>
                <span class="jp">あの人の"この時間"に聴いている曲をのぞく</span>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        © 2026 WHAT U VIBIN TO / One QR, different vibes
    </footer>

    <div class="explore-overlay" id="exploreOverlay">
        
        <div class="explore-header-trigger" onclick="closeExplore()">
            <div class="drag-handle"></div>
        </div>

        <div class="explore-container">
            <div class="dig-content">
                
                <div class="explore-hero">
                    <img src="images/3D_newLogo.svg" alt="WHAT U VIBIN TO?" class="explore-hero-logo">
                    <p class="explore-hero-copy">
                        このQRは、生きている。<br>
                        あの人の"この時間"に聴いている音を見てみよう。
                    </p>
                </div>

                <div class="search-area">
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="Name or Location...">
                        <button class="search-btn">SEARCH</button>
                    </div>
                    <div class="genre-filter-area">
                        <div class="genre-label">FILTER BY GENRE:</div>
                        <div class="genre-checkboxes" id="genreCheckboxes"></div>
                        <button class="filter-reset-btn" id="resetBtn" style="display:none;">RESET (ALL)</button>
                    </div>
                </div>

                <div class="profile-list" id="profileContainer"></div>
                
                <div class="explore-footer">
                    KEEP DIGGING, KEEP VIBING.
                </div>
            </div>
        </div>
    </div>

    <div class="qr-modal-overlay" id="qrModal">
        <div class="qr-modal-content art-layout">
            <button class="qr-modal-close" onclick="closeQrModal()"></button>
            <div class="art-image-section">
                <img src="" alt="Profile Photo" id="modalPhoto">
            </div>
            <div class="art-info-section">
                <div class="art-info-header">
                    <div class="art-name-row">
                        <h2 class="art-name" id="modalName">NAME</h2>
                        <span class="art-role-badge" id="modalRole">DJ</span>
                    </div>
                    <div class="art-meta-row">
                        <span class="art-location" id="modalLocation">TOKYO</span>
                        <span class="art-slash">/</span>
                        <span class="art-genre" id="modalGenre">GENRE</span>
                    </div>
                </div>
                <div class="art-qr-wrapper">
                    <div class="art-qr-box">
                        <a id="modalQrLink" href="#" target="_blank" rel="noopener noreferrer">
                            <img src="" alt="QR Code" id="modalQr">
                        </a>
                    </div>
                    <p class="art-instruction-text">Tap or Scan the QR</p>
                </div>
                <div class="art-info-footer" id="modalInstaArea">
                    <a id="modalInstaLink" href="#" target="_blank" rel="noopener noreferrer" class="art-insta-link">
                        <div class="insta-left">
                            <img src="images/InstagramLogo.png" alt="IG" class="insta-icon">
                            <span class="insta-val" id="modalInstaName">username</span>
                        </div>
                        <span class="art-instruction-text">Tap & Check the profile</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="js/dig_data.js"></script>

    <script>
        const heroSection = document.getElementById('heroSection');
        const exploreOverlay = document.getElementById('exploreOverlay');
        const menuBtn = document.getElementById('menuBtn');
        const menuPanel = document.getElementById('menuPanel');
        let isExploreOpen = false;
        let isMenuOpen = false;

        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            if (isMenuOpen) {
                menuPanel.classList.add('active');
                menuBtn.classList.add('active');
            } else {
                menuPanel.classList.remove('active');
                menuBtn.classList.remove('active');
            }
        }
        menuBtn.addEventListener('click', toggleMenu);

        // --- Explore開閉 (アニメーション連動) ---
        window.openExplore = function() {
            exploreOverlay.classList.add('active');
            heroSection.classList.add('hero-hidden');
            isExploreOpen = true;
            if (!window.exploreInitialized) {
                initExplore();
                window.exploreInitialized = true;
            }
        };

        window.closeExplore = function() {
            exploreOverlay.classList.remove('active');
            heroSection.classList.remove('hero-hidden');
            isExploreOpen = false;
            setTimeout(() => { exploreOverlay.scrollTop = 0; }, 500);
        };

        // --- スワイプ検知 (画面下部のみ) ---
        let touchStartY = 0;
        let touchEndY = 0;

        document.addEventListener('touchstart', e => {
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: true});

        document.addEventListener('touchend', e => {
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            const swipeDistance = touchStartY - touchEndY;
            const threshold = 50; 
            const windowHeight = window.innerHeight;
            // 画面の下15%エリアから開始した場合のみ判定
            const isBottomTriggerArea = touchStartY > (windowHeight * 0.85);

            if (!isExploreOpen) {
                if (isBottomTriggerArea && swipeDistance > threshold) {
                    openExplore();
                }
            } else {
                if (exploreOverlay.scrollTop <= 0 && swipeDistance < -threshold) {
                    closeExplore();
                }
            }
        }

        // --- Explore機能 ---
        const container = document.getElementById('profileContainer');
        const modal = document.getElementById('qrModal');
        const mName = document.getElementById('modalName');
        const mGenre = document.getElementById('modalGenre');
        const mPhoto = document.getElementById('modalPhoto');
        const mQr = document.getElementById('modalQr');
        const mQrLink = document.getElementById('modalQrLink');
        const mRole = document.getElementById('modalRole');
        const mLocation = document.getElementById('modalLocation');
        const mInstaArea = document.getElementById('modalInstaArea');
        const mInstaLink = document.getElementById('modalInstaLink');
        const mInstaName = document.getElementById('modalInstaName');
        const searchInput = document.getElementById('searchInput');
        const genreContainer = document.getElementById('genreCheckboxes');
        const resetBtn = document.getElementById('resetBtn');

        let currentSearchTerm = '';
        let selectedGenres = []; 
        let profileData = [];
        
        function initExplore() {
            if (typeof window.digData !== 'undefined') profileData = window.digData;
            else if (typeof digData !== 'undefined') profileData = digData;

            if(profileData.length > 0) {
                profileData.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                generateGenreCheckboxes(); 
                renderProfiles(profileData); 
            }
        }

        function generateGenreCheckboxes() {
            let allGenres = [...new Set(profileData.flatMap(person => person.genre))].sort();
            const mixTag = "DJ MIX";
            if (allGenres.includes(mixTag)) {
                allGenres = allGenres.filter(g => g !== mixTag); 
                allGenres.unshift(mixTag); 
            }
            let html = '';
            allGenres.forEach(genre => {
                const specialClass = (genre === mixTag) ? 'special-tag' : '';
                html += `<label class="genre-tag ${specialClass}"><input type="checkbox" value="${genre}" onchange="handleGenreChange(this)"><span class="genre-name">${genre}</span></label>`;
            });
            genreContainer.innerHTML = html;
        }

        function renderProfiles(data) {
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center;width:100%;grid-column:1/-1;margin-top:50px;font-weight:bold;">NO VIBES FOUND...</p>';
                return;
            }
            let html = '';
            data.forEach((person, index) => {
                const delay = index * 0.05; 
                const genreText = person.genre.join(', ');
                const serviceIconUrl = person.serviceIcon || "images/default_icon.png"; 
                const role = person.role || "";
                const roleBadge = role ? `<span class="role-badge">${role}</span>` : "";
                let linkUrl = person.id ? `profile.html?id=${person.id}` : (person.qrLink || "#");
                const instaId = person.instagram || "";
                const location = person.location || "";

                html += `
                <div class="profile-card" style="animation-delay: ${delay}s" 
                     onclick="openQrModal('${person.name}', '${genreText}', '${person.image}', '${person.qr}', '${linkUrl}', '${instaId}', '${role}', '${location}')">
                    <div class="profile-img"><img src="${person.image}" alt="${person.name}">${roleBadge}</div>
                    <div class="profile-info">
                        <h2 class="profile-name">${person.name}</h2>
                        <span class="profile-loc">${person.location}</span>
                        <div class="profile-bottom-row">
                            <div class="mini-qr-wrapper"><img src="${person.qr}" alt="QR" class="mini-qr"></div>
                            <div class="service-icon-wrapper"><img src="${serviceIconUrl}" alt="Service" class="service-icon"></div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function applyFilters() {
            const filtered = profileData.filter(person => {
                const term = currentSearchTerm.toLowerCase();
                const textMatch = !term || person.name.toLowerCase().includes(term) || person.location.toLowerCase().includes(term) || person.genre.some(g => g.toLowerCase().includes(term));
                const genreMatch = selectedGenres.length === 0 || person.genre.some(g => selectedGenres.includes(g));
                return textMatch && genreMatch;
            });
            renderProfiles(filtered);
            resetBtn.style.display = selectedGenres.length > 0 ? 'inline-block' : 'none';
        }

        searchInput.addEventListener('input', (e) => { currentSearchTerm = e.target.value; applyFilters(); });
        window.handleGenreChange = function(checkbox) {
            const val = checkbox.value;
            if (checkbox.checked) selectedGenres.push(val); else selectedGenres = selectedGenres.filter(g => g !== val);
            applyFilters();
        };
        resetBtn.addEventListener('click', () => {
            selectedGenres = [];
            genreContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            applyFilters();
        });

        window.openQrModal = function(name, genre, imageSrc, qrSrc, linkUrl, instaId, role, location) {
            mName.textContent = name;
            mGenre.textContent = genre;
            mLocation.textContent = location;
            mPhoto.src = imageSrc;
            mQr.src = qrSrc;
            mQrLink.href = linkUrl;
            if (role) { mRole.textContent = role; mRole.style.display = "inline-block"; } else { mRole.style.display = "none"; }
            if (instaId) { mInstaArea.style.display = "flex"; mInstaName.textContent = instaId; mInstaLink.href = "https://instagram.com/" + instaId; } else { mInstaArea.style.display = "none"; }
            modal.classList.add('active');
        };
        window.closeQrModal = function() { modal.classList.remove('active'); };
        modal.addEventListener('click', (e) => { if (e.target === modal) closeQrModal(); });
    </script>
</body>
</html>
