<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
</head>
<body>

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// LOVE IS FREE /// WHAT U VIBIN TO? /// I WANNA GO TO AMSTERDAM /// WHAT U VIBIN TO? /// LOVE IS FREE /// WHAT U VIBIN TO? /// I WANNA GO TO AMSTERDAM /// WHAT U VIBIN TO? /// LOVE IS FREE ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper">
        <a href="#" onclick="closeAboutPanel(); return false;">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="main-content">
        <nav class="nav-links" id="navLinks"> 
            <a href="#" onclick="openAboutPanel(); return false;">About</a>
            <a href="books.html" id="booksLink">Books</a>
            <a href="contact.html" id="contactLink">Contact</a>
            <a href="dig.html" class="special-link" id="digLink">Dig for new music</a>
            <a href="event.html">Events</a>
        </nav>

        <div class="record-wrapper" id="recordArea">
            <img src="images/record_v2.svg" alt="Vinyl Record" class="record-img" id="recordDisk">
        </div>
    </div>

    <div class="footer">
        Developed by Lucy, Wassup bro
    </div>
</div>

<div class="about-bottom-panel panel-animate" id="swipePanel">
    <div class="panel-header" id="panelHeader">
        <div class="swipe-indicator"></div>
    </div>
    <div class="about-scroll-container" id="panelContent">
        <div class="about-content-inner">
            
            <div class="about-panel-logo">
                <img src="images/logo.svg" alt="Logo">
            </div>

            <p class="logo-note">
                ã€ŒWhat u vibin to?ã€ã¨ã¯ã€<br>
                ã€Œæœ€è¿‘ä½•ã«ãƒã£ã¦ã‚“ã®ï¼Ÿã€ã€Œæœ€è¿‘ã©ã‚“ãªæ›²è´ã„ã¦ã‚“ã®ï¼Ÿã€<br>
                ã¨ã„ã†ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã®å£èªã§ã™ã€‚ä½¿ã£ã¦ã¿ã¦ã­ã€‚
            </p>

            <h2 class="about-main-title">ABOUT</h2>
            <p class="about-intro">
                ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€<br>
                æ°—ã«ãªã‚‹ã‚ã®äººã®éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚<br>
                ãœã²ã€æ–°ã—ã„éŸ³æ¥½ã¨ã®å‡ºä¼šã„ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã€‚<br>
                <span class="small-note">This site features playlists from people youâ€™re curious about.<br>
                    Find your next favorite song. Happy digging!!</span>
            </p>

            <div class="about-columns">
                <dl>
                    <dt><a href="books.html">Books</a></dt>
                    <dd>ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¢ãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br>
                        â€»æº–å‚™ä¸­...è»è³‡é‡‘ãŒãã‚ã„æ¬¡ç¬¬å§‹å‹•ã—ã¾ã™...<br>
                    <span class="small-note">Explore the original artbook archives. <br>
                        Coming soon... Launching as soon as the war chest is full!</span></dd>
                </dl>
                <dl>
                    <dt><a href="contact.html">Contact</a></dt>
                    <dd>æœ¬ã‚µã‚¤ãƒˆã§ã®æ²è¼‰ä¾é ¼ãªã©ã€ãŠå•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰ã‹ã‚‰<br>
                    <span class="small-note">Want to be featured? Get in touch with me here for inquiries and requests.</span></dd>
                </dl>
                <dl>
                    <dt class="highlight-text"><a href="dig.html">Dig for new music</a></dt>
                    <dd>æœ¬ã‚µã‚¤ãƒˆã®ãƒ¡ã‚¤ãƒ³ã«ã‚ãŸã‚‹ãƒ‡ã‚£ã‚°ãƒšãƒ¼ã‚¸ã§ã™ã€‚<br>
                    æ°—ã«ãªã‚‹ã‚ã®äººã®ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¸QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãŠé‚ªé­”ã—ã¾ã™ã€‚<br>
                    ã¡ãªã¿ã«ã“ã“ã ã‘ã®è©±..æ²è¼‰ã—ã¦ã„ã‚‹QRã‚³ãƒ¼ãƒ‰ã¯é–‹ã„ãŸæ™‚é–“å¸¯ã«ã‚ˆã£ã¦é•ã†ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«é£›ã¶ä»•æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚<br>
                    ã•ã‚ã€ã‚ãªãŸã¯ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã‹<br>
                    <span class="small-note">Welcome to Main "Dig" page.<br>
                        Scan the QR codes to jump straight into the music playlists of our featured personalities.<br>
                        Just between us... the QR code drops different playlists depending on when you scan. Think you can find them all? ğŸ˜</span></dd>
                </dl>
                <dl>
                    <dt><a href="event.html">Events</a></dt>
                    <dd>ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚ã•ã‚ã€å¤œã®è¡—ã¸ç¹°ã‚Šå‡ºãã†<br>
                    <span class="small-note">Check out the latest event listings. Time to hit the town.</span></dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<audio id="scratchAudio" src="images/scratch.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {

    /* =================================================================
       æ©Ÿèƒ½1: Aboutãƒ‘ãƒãƒ«ã®åˆ¶å¾¡
       ================================================================= */
    const panel = document.getElementById('swipePanel');
    const panelHeader = document.getElementById('panelHeader');
    const panelContent = document.getElementById('panelContent');
    const navLinks = document.querySelector('.nav-links');
    
    // ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹ç®¡ç†
    let isPanelOpen = false;
    let isPanelDragging = false;
    let panelStartY = 0;
    let panelCurrentY = 0;

    // --- å…¬é–‹é–¢æ•° (HTMLã®onclickã‹ã‚‰å‘¼ã¶) ---
    window.openAboutPanel = function() {
        if(!panel) return;
        panel.style.transform = 'translateY(0)';
        isPanelOpen = true;
        if(navLinks) navLinks.style.opacity = '0.3'; // ãƒŠãƒ“ã‚’ç›®ç«‹ãŸãªãã™ã‚‹
    };

    window.closeAboutPanel = function() {
        if(!panel) return;
        panel.style.transform = 'translateY(100%)';
        isPanelOpen = false;
        if(navLinks) navLinks.style.opacity = '1';
        // é–‰ã˜ãŸå¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        setTimeout(() => { if(panelContent) panelContent.scrollTop = 0; }, 300);
    };

    // --- ãƒ‘ãƒãƒ«ã®ã‚¿ãƒƒãƒæ“ä½œ ---
    if(panel) {
        // ã‚¿ãƒƒãƒé–‹å§‹
        panel.addEventListener('touchstart', (e) => {
            const touchY = e.touches[0].clientY;
            const scrollTop = panelContent.scrollTop;
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’è§¦ã£ãŸã‹åˆ¤å®š
            const isHeader = panelHeader.contains(e.target);
            
            // ã€Œä¸­èº«ã€ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã¯ãƒ‘ãƒãƒ«è‡ªä½“ã‚’å‹•ã‹ã•ãªã„
            // (ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ´ã‚“ã§ã„ã‚‹æ™‚ã€ã¾ãŸã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãƒˆãƒƒãƒ—ã®æ™‚ã ã‘å‹•ã‹ã™)
            if (!isHeader && scrollTop > 0) {
                isPanelDragging = false;
                return;
            }
            isPanelDragging = true;
            panelStartY = touchY;
            panel.classList.remove('panel-animate'); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ•
        }, { passive: false });

        // ã‚¿ãƒƒãƒç§»å‹•
        panel.addEventListener('touchmove', (e) => {
            if (!isPanelDragging) return;
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - panelStartY; 
            
            let newY = deltaY;
            if (deltaY < 0) newY = deltaY * 0.3; // ä¸Šã«å¼•ã£å¼µã‚‹æ™‚ã¯æŠµæŠ—ã‚’ã¤ã‘ã‚‹
            
            // ä¸‹æ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆé–‰ã˜ã‚‹å‹•ä½œï¼‰ã®æ™‚ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã‚’é˜²ã
            if (deltaY > 0 && e.cancelable) e.preventDefault();

            panel.style.transform = `translateY(${newY}px)`;
            panelCurrentY = newY;
        }, { passive: false });

        // ã‚¿ãƒƒãƒçµ‚äº†
        panel.addEventListener('touchend', () => {
            if (!isPanelDragging) return;
            isPanelDragging = false;
            panel.classList.add('panel-animate'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ³ã«æˆ»ã™

            // 150pxä»¥ä¸Šä¸‹ã«å¼•ã£å¼µã£ãŸã‚‰é–‰ã˜ã‚‹
            if (panelCurrentY > 150) {
                closeAboutPanel();
            } else {
                // å…ƒã®ä½ç½®ã«æˆ»ã‚‹
                panel.style.transform = `translateY(0px)`;
                panelCurrentY = 0;
            }
        });

        // ãƒ‘ãƒãƒ«å¤–ï¼ˆèƒŒæ™¯ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (isPanelOpen && panel) {
                // ãƒ‘ãƒãƒ«è‡ªä½“ã€ã¾ãŸã¯ã€Œé–‹ããƒœã‚¿ãƒ³ã€ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
                if (!panel.contains(e.target) && !e.target.closest('a[onclick*="openAboutPanel"]')) {
                    closeAboutPanel();
                }
            }
        });

    }

    /* =================================================================
       æ©Ÿèƒ½3: ãƒšãƒ¼ã‚¸é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (Dig & Contact & Books)
       ================================================================= */
    const digLink = document.getElementById('digLink');
    const contactLink = document.getElementById('contactLink');
    const booksLink = document.getElementById('booksLink'); // â˜…è¿½åŠ 
    
    const navLinksContainer = document.getElementById('navLinks');
    const recordWrapper = document.getElementById('recordArea');

    function handlePageTransition(e) {
        e.preventDefault(); 
        const targetUrl = e.currentTarget.href; 

        if(recordWrapper) recordWrapper.classList.add('slide-out-left');
        if(navLinksContainer) navLinksContainer.classList.add('slide-out-right');

        setTimeout(() => {
            window.location.href = targetUrl;
        }, 800);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    if (digLink) digLink.addEventListener('click', handlePageTransition);
    if (contactLink) contactLink.addEventListener('click', handlePageTransition);
    // â˜…è¿½åŠ 
    if (booksLink) booksLink.addEventListener('click', handlePageTransition);

    // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã§æˆ»ã£ã¦ããŸæ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†
    window.addEventListener('pageshow', (event) => {
        if (event.persisted) { // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå ´åˆ
            if(recordWrapper) recordWrapper.classList.remove('slide-out-left');
            if(navLinksContainer) navLinksContainer.classList.remove('slide-out-right');
        }
    });


    /* =================================================================
       æ©Ÿèƒ½2: ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒ (Web Audio API)
       ================================================================= */
    const recordArea = document.getElementById('recordArea');
    const recordDisk = document.getElementById('recordDisk');
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    const AUDIO_URL = 'images/scratch.mp3'; 
    const FRICTION = 0.92;   // æ‘©æ“¦ï¼ˆæ…£æ€§ï¼‰
    const SENSITIVITY = 1.2; // æ„Ÿåº¦

    // Web Audioå¤‰æ•°
    let audioCtx = null;
    let audioBuffer = null;
    let sourceNode = null;
    let gainNode = null;
    let isAudioUnlocked = false;

    // ãƒ¬ã‚³ãƒ¼ãƒ‰ç‰©ç†æ¼”ç®—å¤‰æ•°
    let isRecordDragging = false;
    let recordVelocity = 0;
    let recordCurrentRotation = 0;
    let recordLastMouseAngle = 0;
    
    // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
    async function loadAudio() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            const response = await fetch(AUDIO_URL);
            const arrayBuffer = await response.arrayBuffer();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.error("Audio Load Error:", error);
        }
    }
    loadAudio();

    // ã‚¹ãƒãƒ›ç”¨ãƒ­ãƒƒã‚¯è§£é™¤ (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®åˆå›ã«å®Ÿè¡Œ)
    function unlockAudio() {
        if (isAudioUnlocked || !audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
        isAudioUnlocked = true;
    }

    // éŸ³ã®å†ç”Ÿåˆ¶å¾¡
    function updateSound(currentVel) {
        if (!audioCtx || !audioBuffer) return;

        // éŸ³ãŒé³´ã£ã¦ãªã„ & é€Ÿåº¦ãŒå‡ºã¦ã„ã‚‹ãªã‚‰å†ç”Ÿé–‹å§‹
        if (!sourceNode && Math.abs(currentVel) > 0.1) {
            sourceNode = audioCtx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.loop = true;
            gainNode = audioCtx.createGain();
            sourceNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            sourceNode.start(0);
        }

        if (sourceNode && gainNode) {
            // é€Ÿåº¦ã«å¿œã˜ã¦ãƒ”ãƒƒãƒã‚’å¤‰ãˆã‚‹
            let speed = Math.abs(currentVel) * SENSITIVITY;
            if (speed > 3.0) speed = 3.0; 
            if (speed < 0.05) speed = 0;

            const now = audioCtx.currentTime;
            sourceNode.playbackRate.setTargetAtTime(speed, now, 0.02);
            // é€Ÿåº¦ã«å¿œã˜ã¦éŸ³é‡ã‚‚å¤‰ãˆã‚‹
            const volume = Math.min(speed, 1.0);
            gainNode.gain.setTargetAtTime(volume, now, 0.02);
        }
    }

    // éŸ³ã®åœæ­¢
    function stopSound() {
        if (sourceNode) {
            const node = sourceNode;
            const gain = gainNode;
            sourceNode = null; 
            gainNode = null;
            if (gain && audioCtx) {
                gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
                setTimeout(() => { try { node.stop(); } catch(e){} }, 150);
            }
        }
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ— (å¸¸ã«å›ã£ã¦ã„ã‚‹ç›£è¦–å½¹)
    function animateRecord() {
        if (!isRecordDragging) {
            recordVelocity *= FRICTION; // æ‰‹ã‚’é›¢ã—ãŸã‚‰æ‘©æ“¦ã§æ¸›é€Ÿ
        }

        if (Math.abs(recordVelocity) < 0.001) {
            recordVelocity = 0;
            stopSound();
        } else {
            recordCurrentRotation += recordVelocity;
            if(recordDisk) recordDisk.style.transform = `rotate(${recordCurrentRotation}deg)`;
            updateSound(recordVelocity);
        }
        requestAnimationFrame(animateRecord);
    }
    animateRecord();

    // åº§æ¨™è¨ˆç®—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getCenter(el) {
        const rect = el.getBoundingClientRect();
        return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
    }
    function getAngle(x, y, center) {
        const dy = y - center.y;
        const dx = x - center.x;
        return Math.atan2(dy, dx) * (180 / Math.PI);
    }

    // --- ãƒ¬ã‚³ãƒ¼ãƒ‰æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ ---
    if(recordArea) {
        function startRecordDrag(x, y) {
            // â˜…é‡è¦: ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã¯ã€ãƒ¬ã‚³ãƒ¼ãƒ‰æ“ä½œã‚’ã•ã›ãªã„
            if (isPanelOpen) return;
            
            unlockAudio();
            isRecordDragging = true;
            const center = getCenter(recordArea);
            recordLastMouseAngle = getAngle(x, y, center);
            recordArea.style.cursor = 'grabbing';
        }

        function moveRecordDrag(x, y) {
            if (!isRecordDragging) return;
            const center = getCenter(recordArea);
            const angle = getAngle(x, y, center);
            let delta = angle - recordLastMouseAngle;
            // è§’åº¦ã®è£œæ­£ (-180ã€œ180)
            while (delta <= -180) delta += 360;
            while (delta > 180) delta -= 360;
            recordVelocity = delta;
            recordLastMouseAngle = angle;
        }

        function endRecordDrag() {
            isRecordDragging = false;
            recordArea.style.cursor = 'grab';
        }

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        recordArea.addEventListener('mousedown', e => startRecordDrag(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => moveRecordDrag(e.clientX, e.clientY));
        window.addEventListener('mouseup', endRecordDrag);

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        recordArea.addEventListener('touchstart', e => {
            if (isPanelOpen) return; 
            startRecordDrag(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

        window.addEventListener('touchmove', e => {
            if (isRecordDragging) {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
                moveRecordDrag(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        window.addEventListener('touchend', endRecordDrag);
    }
});
</script>

</body>
</html>
