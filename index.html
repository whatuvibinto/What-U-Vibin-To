<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
</head>
<body>

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// I WANNA GO TO AMSTERDAM /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// WHAT U VIBIN TO? /// TOKYO /// STRICTLY VINYL ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper">
        <a href="index.html">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="main-content">
        <nav class="nav-links">
            <a href="about.html">About</a>
            <a href="books.html">Books</a>
            <a href="contact.html">Contact</a>
            <a href="dig.html" class="special-link">Dig for new music</a>
            <a href="event.html">Events</a>
        </nav>

        <div class="record-wrapper" id="recordArea">
            <img src="images/record.svg" alt="Vinyl Record" class="record-img" id="recordDisk">
        </div>
    </div>

    <div class="footer">
        Developed by Lucy, Wassup bro
    </div>
</div>

<audio id="scratchAudio" src="images/scratch.mp3" preload="auto"></audio>
<script>
    /* --- JavaScript リアルスクラッチ機能 (<audio>タグ操作版) --- */

    const recordArea = document.getElementById('recordArea');
    const recordDisk = document.getElementById('recordDisk');
    const audio = document.getElementById('scratchAudio');

    // ★重要: スクラッチ音らしくするためにピッチ補正を切る
    if (audio.preservesPitch !== undefined) {
        audio.preservesPitch = false;
    } else if (audio.mozPreservesPitch !== undefined) {
        audio.mozPreservesPitch = false;
    } else if (audio.webkitPreservesPitch !== undefined) {
        audio.webkitPreservesPitch = false;
    }

    let isDragging = false;
    let startAngle = 0;
    let currentRotation = 0;
    let lastRotation = 0;
    let lastTime = 0;
    let audioTimeout;

    // 中心座標を取得
    function getCenter(element) {
        const rect = element.getBoundingClientRect();
        return {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2
        };
    }

    // 角度を取得
    function getAngle(x, y, center) {
        const dy = y - center.y;
        const dx = x - center.x;
        let theta = Math.atan2(dy, dx); 
        theta *= 180 / Math.PI; 
        return theta;
    }

    // 音を制御する関数
    function updateScratchSound(velocity) {
        // 速度の絶対値（方向に関係なく速さだけ見る）
        let speed = Math.abs(velocity);

        // 速すぎる・遅すぎる場合の制限
        if (speed > 4) speed = 4; // 最大4倍速
        if (speed < 0.1) speed = 0; // 遅すぎたら0

        if (speed > 0) {
            // 音が止まっていたら再生開始
            if (audio.paused) {
                audio.play().catch(e => console.log("再生エラー: 画面を一度クリックしてください"));
            }
            // 速度に合わせて再生速度(ピッチ)を変える
            audio.playbackRate = speed;
            
            // 音量を最大に
            audio.volume = 1;

            // 回転が止まったら音を止めるためのタイマーリセット
            clearTimeout(audioTimeout);
            audioTimeout = setTimeout(() => {
                // 少しフェードアウトっぽく止める
                audio.volume = 0.1;
                setTimeout(() => audio.pause(), 100);
            }, 100);
        }
    }

    // --- ドラッグ開始 ---
    const startDrag = (clientX, clientY) => {
        isDragging = true;
        
        // ユーザー操作のタイミングで必ず一度再生（無音で）して、ブラウザの制限を解除する
        if (audio.paused) {
            audio.volume = 0;
            audio.play().then(() => {
                audio.pause();
                audio.volume = 1;
            }).catch(e => console.error(e));
        }

        const center = getCenter(recordArea);
        startAngle = getAngle(clientX, clientY, center) - currentRotation;
        recordArea.style.cursor = 'grabbing';
        
        lastTime = Date.now();
        lastRotation = currentRotation;
    };

    // --- ドラッグ中（回転と音） ---
    const moveDrag = (clientX, clientY) => {
        if (!isDragging) return;

        const center = getCenter(recordArea);
        const angle = getAngle(clientX, clientY, center);
        const newRotation = angle - startAngle;
        
        // レコードを回転させる
        recordDisk.style.transform = `rotate(${newRotation}deg)`;

        // --- 速度計算 ---
        const now = Date.now();
        const deltaTime = now - lastTime;
        
        if (deltaTime > 15) { // 計算頻度を少し落として負荷軽減
            const deltaRotation = newRotation - lastRotation;
            
            // 速度 = 角度の変化 / 時間
            // 係数 15 で感度調整
            const velocity = (deltaRotation / deltaTime) * 15;

            // 音の更新
            updateScratchSound(velocity);

            lastRotation = newRotation;
            lastTime = now;
        }
        
        currentRotation = newRotation;
    };

    // --- ドラッグ終了 ---
    const endDrag = () => {
        isDragging = false;
        recordArea.style.cursor = 'grab';
        
        // 手を離したら音を止める
        audio.pause();
    };


    // --- イベントリスナー ---

    // PC (Mouse)
    recordArea.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY));
    window.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY));
    window.addEventListener('mouseup', endDrag);

    // スマホ (Touch)
    recordArea.addEventListener('touchstart', (e) => {
        // e.preventDefault(); // スクロールを止めたくない場合はコメントアウトのまま
        startDrag(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        // e.preventDefault(); 
        moveDrag(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: false });
    
    window.addEventListener('touchend', endDrag);

</script>

</body>
</html>
