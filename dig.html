<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIG - WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
    <link rel="stylesheet" href="css/style_dig.css">
</head>
<body class="dig-page">

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// LOVE IS FREE /// WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// LOVE IS FREE ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper dig-logo">
        <a href="index.html">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="dig-content">
        <div class="search-area">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="NAME or LOCATION...">
                <button class="search-btn">SEARCH</button>
            </div>
            
            <div class="genre-filter-area">
                <div class="genre-label">FILTER BY GENRE:</div>
                <div class="genre-checkboxes" id="genreCheckboxes"></div>
                <button class="filter-reset-btn" id="resetBtn" style="display:none;">RESET (ALL)</button>
            </div>
        </div>

        <div class="profile-list" id="profileContainer"></div>
    </div>

    <div class="footer">
        KEEP DIGGING, KEEP VIBING.
    </div>
</div>

<div class="qr-modal-overlay" id="qrModal">
    <div class="qr-modal-content art-layout">
        <button class="qr-modal-close" onclick="closeQrModal()"></button>
        
        <div class="art-image-section">
            <img src="" alt="Profile Photo" id="modalPhoto">
            <span class="art-role-badge" id="modalRole">DJ</span>
        </div>

        <div class="art-info-section">
            <div class="art-info-header">
                <h2 class="art-name" id="modalName">NAME</h2>
                <div class="art-meta-row">
                    <span class="art-location" id="modalLocation">TOKYO</span>
                    <span class="art-slash">/</span>
                    <span class="art-genre" id="modalGenre">GENRE</span>
                </div>
                
                <div class="art-insta-wrapper" id="modalInstaArea">
                    <a id="modalInstaLink" href="#" target="_blank" rel="noopener noreferrer" class="art-insta-link">
                        <span class="insta-label">IG.</span>
                        <span class="insta-val" id="modalInstaName">username</span>
                        <span class="insta-suffix">Tap & Check the profile</span>
                    </a>
                </div>
            </div>

            <div class="art-info-footer">
                <div class="art-qr-container">
                    <a id="modalQrLink" href="#" target="_blank" rel="noopener noreferrer">
                        <img src="" alt="QR Code" id="modalQr">
                    </a>
                </div>
                <p class="art-scan-text">Scan or Touch This QR</p>
            </div>
        </div>
    </div>
</div>

<script src="js/dig_data.js"></script>
<script>
    const container = document.getElementById('profileContainer');
    const modal = document.getElementById('qrModal');
    
    // モーダル要素
    const modalName = document.getElementById('modalName');
    const modalGenre = document.getElementById('modalGenre');
    const modalPhoto = document.getElementById('modalPhoto');
    const modalQr = document.getElementById('modalQr');
    const modalQrLink = document.getElementById('modalQrLink');
    const modalRole = document.getElementById('modalRole');
    const modalLocation = document.getElementById('modalLocation');
    
    // インスタ要素
    const modalInstaArea = document.getElementById('modalInstaArea');
    const modalInstaLink = document.getElementById('modalInstaLink');
    const modalInstaName = document.getElementById('modalInstaName');

    const searchInput = document.getElementById('searchInput');
    const genreContainer = document.getElementById('genreCheckboxes');
    const resetBtn = document.getElementById('resetBtn');

    let currentSearchTerm = '';
    let selectedGenres = []; 
    
    // データ読み込み（window.digDataを使用）
    const profileData = window.digData || [];

    function init() {
        if (profileData.length === 0) {
            console.error("データが読み込めていません。js/dig_data.jsを確認してください。");
        }
        profileData.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
        generateGenreCheckboxes();
        renderProfiles(profileData); 
    }

    function generateGenreCheckboxes() {
        let allGenres = [...new Set(profileData.flatMap(person => person.genre))].sort();
        const mixTag = "DJ MIX";
        if (allGenres.includes(mixTag)) {
            allGenres = allGenres.filter(g => g !== mixTag); 
            allGenres.unshift(mixTag); 
        }

        let html = '';
        allGenres.forEach(genre => {
            const specialClass = (genre === mixTag) ? 'special-tag' : '';
            html += `
                <label class="genre-tag ${specialClass}">
                    <input type="checkbox" value="${genre}" onchange="handleGenreChange(this)">
                    <span class="genre-name">${genre}</span>
                </label>
            `;
        });
        genreContainer.innerHTML = html;
    }

    function renderProfiles(data) {
        if (data.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px;">NO VIBES FOUND...</p>';
            return;
        }

        let html = '';
        data.forEach((person, index) => {
            const delay = index * 0.05; 
            const genreText = person.genre.join(', ');
            const serviceIconUrl = person.serviceIcon || "images/default_icon.png"; 

            const role = person.role || "";
            const roleBadge = role ? `<span class="role-badge">${role}</span>` : "";
            const linkUrl = person.qrLink || "#";
            const instaId = person.instagram || "";
            const location = person.location || "";

            html += `
            <div class="profile-card" style="animation-delay: ${delay}s" 
                 onclick="openQrModal('${person.name}', '${genreText}', '${person.image}', '${person.qr}', '${linkUrl}', '${instaId}', '${role}', '${location}')">
                
                <div class="profile-img">
                    <img src="${person.image}" alt="${person.name}">
                    ${roleBadge}
                </div>

                <div class="profile-info">
                    <h2 class="profile-name">${person.name}</h2>
                    <span class="profile-loc">${person.location}</span>
                    <p class="profile-genre-text">${genreText}</p>
                    
                    <div class="profile-bottom-row">
                        <div class="mini-qr-wrapper">
                            <img src="${person.qr}" alt="QR" class="mini-qr">
                        </div>
                        <div class="service-icon-wrapper">
                            <img src="${serviceIconUrl}" alt="Service" class="service-icon">
                        </div>
                    </div>
                </div>
            </div>
            `;
        });
        container.innerHTML = html;
    }

    function applyFilters() {
        const filtered = profileData.filter(person => {
            const term = currentSearchTerm.toLowerCase();
            const textMatch = !term || 
                person.name.toLowerCase().includes(term) || 
                person.location.toLowerCase().includes(term) ||
                person.genre.some(g => g.toLowerCase().includes(term));

            const genreMatch = selectedGenres.length === 0 || 
                person.genre.some(g => selectedGenres.includes(g));

            return textMatch && genreMatch;
        });
        renderProfiles(filtered);
        resetBtn.style.display = selectedGenres.length > 0 ? 'inline-block' : 'none';
    }

    searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value;
        applyFilters();
    });

    window.handleGenreChange = function(checkbox) {
        const val = checkbox.value;
        if (checkbox.checked) {
            selectedGenres.push(val);
        } else {
            selectedGenres = selectedGenres.filter(g => g !== val);
        }
        applyFilters();
    };

    resetBtn.addEventListener('click', () => {
        selectedGenres = [];
        const checkboxes = genreContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        applyFilters();
    });

    window.openQrModal = function(name, genre, imageSrc, qrSrc, linkUrl, instaId, role, location) {
        modalName.textContent = name;
        modalGenre.textContent = genre;
        modalLocation.textContent = location;
        
        modalPhoto.src = imageSrc;
        modalQr.src = qrSrc;
        modalQrLink.href = linkUrl;

        if (role) {
            modalRole.textContent = role;
            modalRole.style.display = "block";
        } else {
            modalRole.style.display = "none";
        }

        if (instaId) {
            modalInstaArea.style.display = "block";
            modalInstaName.textContent = instaId;
            modalInstaLink.href = "https://instagram.com/" + instaId;
        } else {
            modalInstaArea.style.display = "none";
        }

        modal.classList.add('active');
    };

    window.closeQrModal = function() {
        modal.classList.remove('active');
    };

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeQrModal();
    });

    init();
</script>

</body>
</html>
