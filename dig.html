<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIG - WHAT U VIBIN TO?</title>
    <link rel="stylesheet" href="css/style_index.css">
    <link rel="stylesheet" href="css/style_dig.css">
</head>
<body class="dig-page">

<div class="marquee-wrapper">
    <div class="marquee-content">
        WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// KEEP DIGGING /// WHAT U VIBIN TO? /// KEEP DIGGING ///
    </div>
</div>

<div class="container">
    <div class="header-logo-wrapper dig-logo">
        <a href="index.html">
            <img src="images/logo.svg" alt="WHAT U VIBIN TO?">
        </a>
    </div>

    <div class="dig-content">
        <div class="search-area">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="NAME or LOCATION...">
                <button class="search-btn">SEARCH</button>
            </div>
            
            <div class="genre-filter-area">
                <div class="genre-label">FILTER BY GENRE:</div>
                <div class="genre-checkboxes" id="genreCheckboxes">
                    </div>
                <button class="filter-reset-btn" id="resetBtn" style="display:none;">RESET (ALL)</button>
            </div>
        </div>

        <div class="profile-list" id="profileContainer">
            </div>
    </div>

    <div class="footer">
        KEEP DIGGING, KEEP VIBING.
    </div>
</div>

<div class="qr-modal-overlay" id="qrModal">
    <div class="qr-modal-content">
        <span class="qr-modal-close" onclick="closeQrModal()">&times;</span>
        
        <h2 class="qr-modal-name" id="modalName">NAME</h2>
        <p class="qr-modal-genre" id="modalGenre">GENRE</p>

        <div class="qr-modal-body">
            <div class="qr-modal-photo-area">
                <img src="" alt="Profile Photo" class="qr-modal-photo" id="modalPhoto">
            </div>
            <div class="qr-modal-code-area">
                <img src="" alt="QR Code" class="qr-modal-qr" id="modalQr">
                <p class="qr-instruction">Scan to listen</p>
            </div>
        </div>
    </div>
</div>

<script src="js/dig_data.js"></script>
<script>
    const container = document.getElementById('profileContainer');
    const modal = document.getElementById('qrModal');
    
    // モーダル要素
    const modalName = document.getElementById('modalName');
    const modalGenre = document.getElementById('modalGenre');
    const modalPhoto = document.getElementById('modalPhoto');
    const modalQr = document.getElementById('modalQr');

    // フィルター要素
    const searchInput = document.getElementById('searchInput');
    const genreContainer = document.getElementById('genreCheckboxes');
    const resetBtn = document.getElementById('resetBtn');

    // 状態管理
    let currentSearchTerm = '';
    let selectedGenres = []; // 選択されたジャンルのリスト

    // --------------------------------------------------
    // 1. 初期化処理 (ジャンル生成 & 初期表示)
    // --------------------------------------------------
    function init() {
        generateGenreCheckboxes();
        renderProfiles(digData); // 全員表示
    }

    // データから全ジャンルを抽出してチェックボックスを作る
    function generateGenreCheckboxes() {
        // 全ジャンルを配列にして重複を削除
        const allGenres = [...new Set(digData.flatMap(person => person.genre))].sort();

        let html = '';
        allGenres.forEach(genre => {
            html += `
                <label class="genre-tag">
                    <input type="checkbox" value="${genre}" onchange="handleGenreChange(this)">
                    <span class="genre-name">${genre}</span>
                </label>
            `;
        });
        genreContainer.innerHTML = html;
    }

    // --------------------------------------------------
    // 2. プロフィール描画
    // --------------------------------------------------
    function renderProfiles(data) {
        if (data.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%; grid-column:1/-1; margin-top:50px;">NO VIBES FOUND...</p>';
            return;
        }

        let html = '';
        data.forEach((person, index) => {
            const delay = index * 0.05; 
            const genreText = person.genre.join(', ');
            const serviceIconUrl = person.serviceIcon || "images/default_icon.png"; 

            html += `
            <div class="profile-card" style="animation-delay: ${delay}s" 
                 onclick="openQrModal('${person.name}', '${genreText}', '${person.image}', '${person.qr}')">
                
                <div class="profile-img">
                    <img src="${person.image}" alt="${person.name}">
                </div>

                <div class="profile-info">
                    <h2 class="profile-name">${person.name}</h2>
                    <span class="profile-loc">${person.location}</span>
                    <p class="profile-genre-text">${genreText}</p>
                    
                    <div class="profile-bottom-row">
                        <div class="mini-qr-wrapper">
                            <img src="${person.qr}" alt="QR" class="mini-qr">
                        </div>
                        <div class="service-icon-wrapper">
                            <img src="${serviceIconUrl}" alt="Service" class="service-icon">
                        </div>
                    </div>
                </div>
            </div>
            `;
        });
        container.innerHTML = html;
    }


    // --------------------------------------------------
    // 3. フィルタリングロジック (検索とジャンルの掛け合わせ)
    // --------------------------------------------------
    function applyFilters() {
        const filtered = digData.filter(person => {
            // A. テキスト検索判定
            const term = currentSearchTerm.toLowerCase();
            const textMatch = !term || 
                person.name.toLowerCase().includes(term) || 
                person.location.toLowerCase().includes(term) ||
                person.genre.some(g => g.toLowerCase().includes(term));

            // B. ジャンルフィルター判定 (OR条件: 選択したジャンルのどれか一つでも持っていればOK)
            // selectedGenresが空(=ALL)なら全員OK
            const genreMatch = selectedGenres.length === 0 || 
                person.genre.some(g => selectedGenres.includes(g));

            return textMatch && genreMatch;
        });

        renderProfiles(filtered);

        // RESETボタンの表示制御
        if (selectedGenres.length > 0) {
            resetBtn.style.display = 'inline-block';
        } else {
            resetBtn.style.display = 'none';
        }
    }

    // --------------------------------------------------
    // 4. イベントリスナー
    // --------------------------------------------------

    // テキスト検索入力時
    searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value;
        applyFilters();
    });

    // チェックボックス変更時 (HTML側の onchange から呼ばれる)
    window.handleGenreChange = function(checkbox) {
        const val = checkbox.value;
        if (checkbox.checked) {
            selectedGenres.push(val);
        } else {
            selectedGenres = selectedGenres.filter(g => g !== val);
        }
        applyFilters();
    };

    // リセットボタン
    resetBtn.addEventListener('click', () => {
        selectedGenres = [];
        // チェックボックスの表示を外す
        const checkboxes = genreContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        applyFilters();
    });

    // モーダル制御
    window.openQrModal = function(name, genre, imageSrc, qrSrc) {
        modalName.textContent = name;
        modalGenre.textContent = genre;
        modalPhoto.src = imageSrc;
        modalQr.src = qrSrc;
        modal.classList.add('active');
    };

    window.closeQrModal = function() {
        modal.classList.remove('active');
    };

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeQrModal();
    });

    // 初期化実行
    init();

</script>

</body>
</html>
